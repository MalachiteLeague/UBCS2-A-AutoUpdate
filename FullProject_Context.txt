==========================================
FILE: Form1.Auth.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Auth.cs
==========================================
using System;
using System.Windows.Forms;

namespace UBCS2_A
{
    public partial class Form1
    {
        // [QUAN TRỌNG] Đã xóa AuthorizationManager _authManager;

        private void SetupAuthorization()
        {
            if (cboKhuVuc == null) return;

            // Nạp danh sách quyền
            cboKhuVuc.Items.Clear();
            cboKhuVuc.Items.AddRange(new string[] {
                "Admin",
                "Hành Chánh T1", "Hành Chánh T3",
                "Huyết học T1", "Sinh hóa T1", "Miễn dịch T1",
                "Huyết học T3", "SH-MD T3",
                "Khách"
            });

            // Sự kiện đổi quyền
            cboKhuVuc.SelectedIndexChanged += (s, e) =>
            {
                string role = cboKhuVuc.SelectedItem?.ToString() ?? "Khách";

                // [GỌI THẲNG VÀO LAB CONTEXT] 
                // Không cần qua trung gian nữa!
                if (_context != null)
                {
                    _context.SetUserRole(role);
                }

                // Cập nhật role cho Task (nếu có logic riêng)
                // if (_taskContext != null) _taskContext.SetRole(role);
            };

            // Mặc định chọn Khách
            cboKhuVuc.SelectedIndex = cboKhuVuc.Items.Count - 1;
        }
    }
}



==========================================
FILE: Form1.Backup.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Backup.cs
==========================================
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Services;

namespace UBCS2_A
{
    // Đây là một phần của Form1, chuyên xử lý Backup & Xóa
    public partial class Form1
    {
        private BackupService _backupService;

        private void SetupBackupSystem()
        {
            // 1. Khởi tạo Service (Logic)
            if (_matrixManager != null && _context != null)
            {
                _backupService = new BackupService(_context, _matrixManager);
                _backupService.StartAutoBackup();
            }

            // 2. Sự kiện nút "Xuất Dữ Liệu" (Thủ công)
            if (btnExport != null)
            {
                btnExport.Click += (s, e) =>
                {
                    string path = _backupService?.PerformExport(isAuto: false);
                    if (!string.IsNullOrEmpty(path))
                    {
                        MessageBox.Show($"Xuất file thành công:\n{path}", "Thông báo");
                        try { Process.Start("explorer.exe", "/select," + path); } catch { }
                    }
                };
            }
            // Kiểm tra xem nút có tồn tại không (đề phòng bạn chưa đặt tên đúng)
            if (btnClearData != null)
            {
                // Gắn hàm BtnClearData_Click vào sự kiện Click của nút
                btnClearData.Click += BtnClearData_Click;
            }
        }

        // --- CÁC HÀM XỬ LÝ LỆNH HỆ THỐNG (COMMAND) ---

        private void SetupSystemCommands(FirebaseService firebase)
        {
            // Đăng ký sự kiện lắng nghe thay đổi dữ liệu
            firebase.OnDataChanged += (s, e) =>
            {
                // 1. LOG DEBUG: Xem máy con thực sự nhận được cái gì
                // Console.WriteLine($"[SYSTEM-DEBUG] Path: {e.Path} | Key: {e.Key} | Data: {e.Data}");

                try
                {
                    // 2. PHÂN TÍCH LINH HOẠT (Chấp nhận nhiều trường hợp đường dẫn)
                    // Trường hợp A: Thay đổi trực tiếp tại node Command (/System/Command)
                    // Trường hợp B: Thay đổi tại node cha System (/System)

                    Newtonsoft.Json.Linq.JToken commandData = null;

                    // Kiểm tra xem dữ liệu trả về có chứa từ khóa quan trọng không
                    if (e.Path.Contains("Command") || e.Path.Contains("System"))
                    {
                        // Nếu path là /System/Command -> Data chính là Command
                        if (e.Path.EndsWith("Command") || e.Key == "Command")
                        {
                            commandData = e.Data;
                        }
                        // Nếu path là /System -> Data chứa Command bên trong
                        else if (e.Data["Command"] != null)
                        {
                            commandData = e.Data["Command"];
                        }
                    }

                    // 3. XỬ LÝ LỆNH
                    if (commandData != null)
                    {
                        // Chuyển về Dictionary để lấy Action
                        var cmd = commandData.ToObject<Dictionary<string, string>>();

                        if (cmd != null && cmd.ContainsKey("Action") && cmd["Action"] == "BACKUP_WIPE")
                        {
                            string timeStr = cmd.ContainsKey("Time") ? cmd["Time"] : DateTime.Now.ToString("HH-mm dd-MM-yyyy");

                            Console.WriteLine($"[SYSTEM] ⚠️ Máy trạm đã nhận lệnh XÓA từ Server! Thời gian: {timeStr}");

                            // Gọi hàm xử lý backup (đã có Invoke bên trong để an toàn luồng)
                            HandleBackupCommand(timeStr);
                        }
                    }
                }
                catch (Exception ex)
                {
                    // Bắt lỗi để biết tại sao không chạy
                    Console.WriteLine($"[SYSTEM-ERR] Lỗi xử lý lệnh Command: {ex.Message}");
                }
            };
        }

        private void HandleBackupCommand(string timeStr)
        {
            if (this.InvokeRequired) { this.Invoke(new Action(() => HandleBackupCommand(timeStr))); return; }

            string safeTime = timeStr.Replace(":", "h");
            string fileName = $"Xóa {safeTime}";

            Console.WriteLine($"[SYSTEM] ⚠️ Nhận lệnh Backup khẩn cấp: {fileName}");
            _backupService?.PerformExport(isAuto: true, customFileName: fileName);
        }

        // --- SỰ KIỆN NÚT "XÓA DỮ LIỆU" ---

        private async void BtnClearData_Click(object sender, EventArgs e)
        {
            var confirm = MessageBox.Show(
                "CẢNH BÁO NGUY HIỂM!\n\n" +
                "Hành động này sẽ:\n" +
                "1. Yêu cầu TẤT CẢ các máy trạm sao lưu dữ liệu.\n" +
                "2. Sau 10 giây, sẽ XÓA SẠCH toàn bộ 9 bảng xét nghiệm, Tasks và Giao nhận.\n\n" +
                "Bạn có chắc chắn muốn tiếp tục không?",
                "Xác nhận Xóa Hệ Thống",
                MessageBoxButtons.YesNo, MessageBoxIcon.Error);

            if (confirm != DialogResult.Yes) return;

            try
            {
                // Gửi lệnh Backup
                string timeStamp = DateTime.Now.ToString("HH:mm dd-MM-yyyy");
                var cmd = new Dictionary<string, string> { { "Action", "BACKUP_WIPE" }, { "Time", timeStamp } };

                var firebase = new FirebaseService(FIREBASE_URL, FIREBASE_SECRET);
                await firebase.UpdateDataAsync("System/Command", cmd);

                Console.WriteLine("[CLEAR-OP] ⏳ Đã gửi lệnh. Đang chờ 10 giây...");

                // Khóa nút để tránh bấm nhiều lần
                if (sender is Button btn) btn.Enabled = false;

                await Task.Delay(10000); // Đợi 10s

                Console.WriteLine("[CLEAR-OP] 🗑️ Bắt đầu xóa dữ liệu...");
                string[] nodesToDelete = new string[]
                {
                    "T1_HuyetHoc_CongThucMau", "T1_HuyetHoc_DongMau", "T1_HuyetHoc_GiamSat", "T1_SinhHoa", "T1_MienDich",
                    "T3_HuyetHoc_CongThucMau", "T3_HuyetHoc_DongMau", "T3_HuyetHoc_GiamSat", "T3_SinhHoa_MienDich",
                    "T_Tasks", "T_Logistics_Matrix"
                };

                foreach (var node in nodesToDelete) await firebase.DeleteDataAsync(node);
                await firebase.DeleteDataAsync("System/Command");

                MessageBox.Show("Đã xóa toàn bộ dữ liệu thành công!", "Hoàn tất", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                if (sender is Button btn) btn.Enabled = true;
            }
        }
    }
}



==========================================
FILE: Form1.Chat.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Chat.cs
==========================================
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1
    {
        private ChatContext _chatContext;

        private void SetupChatSystem(FirebaseService firebase)
        {
            _chatContext = new ChatContext(firebase);

            if (dgvChatAll != null && dgvChatPrivate != null)
            {
                _chatContext.RegisterControls(dgvChatAll, dgvChatPrivate, cboChatTarget, txtChatContent, btnChatSend);

                // Đăng ký sự kiện UI cho Chat
                if (btnChatSend != null) btnChatSend.Click += (s, e) => HandleSendChat();
                if (txtChatContent != null)
                {
                    txtChatContent.KeyDown += (s, e) => {
                        if (e.KeyCode == Keys.Enter)
                        {
                            HandleSendChat();
                            e.SuppressKeyPress = true;
                        }
                    };
                }
            }
        }

        private void HandleSendChat()
        {
            string currentSender = cboKhuVuc.SelectedItem?.ToString() ?? "Khách";
            string target = cboChatTarget.SelectedItem?.ToString() ?? "Toàn viện";
            string content = txtChatContent.Text.Trim();

            if (!string.IsNullOrEmpty(content))
            {
                _chatContext.SendMessageReal(currentSender, target, content);
                txtChatContent.Clear();
                txtChatContent.Focus();
            }
        }

        private async Task StartChatSyncAsync()
        {
            if (_chatContext != null)
            {
                _chatContext.StartSync();
                await _chatContext.LoadInitialDataAsync();
            }
        }
    }
}



==========================================
FILE: Form1.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.cs
==========================================
using System;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1 : Form
    {
        // CẤU HÌNH HỆ THỐNG
        private const string FIREBASE_URL = "https://streamingub-default-rtdb.asia-southeast1.firebasedatabase.app/";
        private const string FIREBASE_SECRET = "APK7gK1JBKh2XUR4laAcTP8P9CxpZoZKBkZ9bm23";

        public Form1()
        {
            InitializeComponent();
        }

        private async void Form1_Load(object sender, EventArgs e)
        {
            Console.OutputEncoding = System.Text.Encoding.UTF8;
            Console.WriteLine("[FORM-CORE] 🏁 KHỞI ĐỘNG HỆ THỐNG (PARTIAL CLASSES)...");

            try
            {
                // 1. KẾT NỐI SERVER
                var firebase = new FirebaseService(FIREBASE_URL, FIREBASE_SECRET);

                // 2. KHỞI TẠO TỪNG PHÂN HỆ
                SetupLabSystem(firebase);       // Form1.Lab.cs
                SetupLogisticsSystem(firebase); // Form1.Logistics.cs
                SetupTaskSystem(firebase);      // Form1.Task.cs
                SetupChatSystem(firebase);      // Form1.Chat.cs

                // 3. CÁC TÍNH NĂNG CHUNG
                SetupAuthorization();           // Form1.Auth.cs
                SetupSearchSystem();            // Form1.Search.cs
                                                // Setup Backup nằm bên Form1.Backup.cs
                SetupBackupSystem();
                SetupSystemCommands(firebase);

                // 4. KIỂM TRA CẬP NHẬT (QUAN TRỌNG: Chạy trước hoặc song song)
                // [NEW] Thêm dòng này vào
                _ = CheckForUpdatesAsync(firebase);

                // 5. KÍCH HOẠT ĐỒNG BỘ (Chạy song song)
                this.Text = "Quản lý Phòng Xét Nghiệm - Đang tải dữ liệu...";

                await Task.WhenAll(
                    StartLabSyncAsync(),
                    StartLogisticsSyncAsync(),
                    StartTaskSyncAsync(),
                    StartChatSyncAsync()
                );

                this.Text = "Quản lý Phòng Xét Nghiệm (Sẵn sàng ✅)";
                Console.WriteLine("[FORM-CORE] ✅ HỆ THỐNG SẴN SÀNG.");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khởi động: {ex.Message}", "Fatal Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ... (Giữ nguyên phần BackupService và OnFormClosing như cũ) ...

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            _backupService?.StopAutoBackup();
            _context?.Dispose();
            _logisticsContext?.Dispose();
            _chatContext?.Dispose();
            _taskContext?.Dispose();
            base.OnFormClosing(e);
        }

    }
}



==========================================
FILE: Form1.Designer.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Designer.cs
==========================================
namespace UBCS2_A
{
    partial class Form1
    {
        /// <summary>
        ///  Required designer variable.
        /// </summary>
        private System.ComponentModel.IContainer components = null;

        /// <summary>
        ///  Clean up any resources being used.
        /// </summary>
        /// <param name="disposing">true if managed resources should be disposed; otherwise, false.</param>
        protected override void Dispose(bool disposing)
        {
            if (disposing && (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);

        }

        #region Windows Form Designer generated code

        /// <summary>
        ///  Required method for Designer support - do not modify
        ///  the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            tabControl1 = new TabControl();
            LuuMau = new TabPage();
            tabControl2 = new TabControl();
            HuyetHocT1 = new TabPage();
            label4 = new Label();
            DataGST1 = new DataGridView();
            dataGridViewTextBoxColumn2 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn3 = new DataGridViewTextBoxColumn();
            label2 = new Label();
            label1 = new Label();
            DataDMT1 = new DataGridView();
            dataGridViewTextBoxColumn1 = new DataGridViewTextBoxColumn();
            SID1 = new DataGridViewTextBoxColumn();
            DataCTMT1 = new DataGridView();
            STT = new DataGridViewTextBoxColumn();
            SID = new DataGridViewTextBoxColumn();
            tabPage4 = new TabPage();
            label7 = new Label();
            DataSHT1 = new DataGridView();
            dataGridViewTextBoxColumn6 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn7 = new DataGridViewTextBoxColumn();
            tabPage1 = new TabPage();
            label10 = new Label();
            DataMDT1 = new DataGridView();
            dataGridViewTextBoxColumn12 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn13 = new DataGridViewTextBoxColumn();
            tabPage3 = new TabPage();
            label11 = new Label();
            DataGST3 = new DataGridView();
            dataGridViewTextBoxColumn16 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn17 = new DataGridViewTextBoxColumn();
            label12 = new Label();
            label13 = new Label();
            DataDMT3 = new DataGridView();
            dataGridViewTextBoxColumn18 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn19 = new DataGridViewTextBoxColumn();
            DataCTMT3 = new DataGridView();
            dataGridViewTextBoxColumn20 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn21 = new DataGridViewTextBoxColumn();
            tabPage5 = new TabPage();
            label16 = new Label();
            DataSHMDT3 = new DataGridView();
            dataGridViewTextBoxColumn24 = new DataGridViewTextBoxColumn();
            dataGridViewTextBoxColumn25 = new DataGridViewTextBoxColumn();
            tabPage2 = new TabPage();
            cboLine = new ComboBox();
            radNuocTieu = new RadioButton();
            dgvInput = new DataGridView();
            txtCarrier = new TextBox();
            radPCD = new RadioButton();
            radXanhDuong = new RadioButton();
            radXanhLa = new RadioButton();
            radDo = new RadioButton();
            radDen = new RadioButton();
            radKhac = new RadioButton();
            btnGui = new Button();
            txtNguoiNhan = new TextBox();
            txtNguoiGui = new TextBox();
            dgvGiaoNhan = new DataGridView();
            txtSearch = new TextBox();
            label3 = new Label();
            btnExport = new Button();
            dgvSearch = new DataGridView();
            dgvChatAll = new DataGridView();
            panel1 = new Panel();
            txtTaskSID = new TextBox();
            dgvTask = new DataGridView();
            cboKhuVuc = new ComboBox();
            txtChatContent = new TextBox();
            cboChatTarget = new ComboBox();
            dgvChatPrivate = new DataGridView();
            btnChatSend = new Button();
            btnClearData = new Button();
            tabControl1.SuspendLayout();
            LuuMau.SuspendLayout();
            tabControl2.SuspendLayout();
            HuyetHocT1.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)DataGST1).BeginInit();
            ((System.ComponentModel.ISupportInitialize)DataDMT1).BeginInit();
            ((System.ComponentModel.ISupportInitialize)DataCTMT1).BeginInit();
            tabPage4.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)DataSHT1).BeginInit();
            tabPage1.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)DataMDT1).BeginInit();
            tabPage3.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)DataGST3).BeginInit();
            ((System.ComponentModel.ISupportInitialize)DataDMT3).BeginInit();
            ((System.ComponentModel.ISupportInitialize)DataCTMT3).BeginInit();
            tabPage5.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)DataSHMDT3).BeginInit();
            tabPage2.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)dgvInput).BeginInit();
            ((System.ComponentModel.ISupportInitialize)dgvGiaoNhan).BeginInit();
            ((System.ComponentModel.ISupportInitialize)dgvSearch).BeginInit();
            ((System.ComponentModel.ISupportInitialize)dgvChatAll).BeginInit();
            panel1.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)dgvTask).BeginInit();
            ((System.ComponentModel.ISupportInitialize)dgvChatPrivate).BeginInit();
            SuspendLayout();
            // 
            // tabControl1
            // 
            tabControl1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
            tabControl1.Controls.Add(LuuMau);
            tabControl1.Controls.Add(tabPage2);
            tabControl1.Location = new Point(265, 13);
            tabControl1.Name = "tabControl1";
            tabControl1.SelectedIndex = 0;
            tabControl1.Size = new Size(675, 493);
            tabControl1.TabIndex = 3;
            // 
            // LuuMau
            // 
            LuuMau.Controls.Add(tabControl2);
            LuuMau.Location = new Point(4, 24);
            LuuMau.Name = "LuuMau";
            LuuMau.Padding = new Padding(3);
            LuuMau.Size = new Size(667, 465);
            LuuMau.TabIndex = 0;
            LuuMau.Text = "Lưu Mẫu";
            LuuMau.UseVisualStyleBackColor = true;
            // 
            // tabControl2
            // 
            tabControl2.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;
            tabControl2.Controls.Add(HuyetHocT1);
            tabControl2.Controls.Add(tabPage4);
            tabControl2.Controls.Add(tabPage1);
            tabControl2.Controls.Add(tabPage3);
            tabControl2.Controls.Add(tabPage5);
            tabControl2.Location = new Point(0, 3);
            tabControl2.Name = "tabControl2";
            tabControl2.SelectedIndex = 0;
            tabControl2.Size = new Size(664, 456);
            tabControl2.TabIndex = 0;
            // 
            // HuyetHocT1
            // 
            HuyetHocT1.Controls.Add(label4);
            HuyetHocT1.Controls.Add(DataGST1);
            HuyetHocT1.Controls.Add(label2);
            HuyetHocT1.Controls.Add(label1);
            HuyetHocT1.Controls.Add(DataDMT1);
            HuyetHocT1.Controls.Add(DataCTMT1);
            HuyetHocT1.Location = new Point(4, 24);
            HuyetHocT1.Name = "HuyetHocT1";
            HuyetHocT1.Padding = new Padding(3);
            HuyetHocT1.Size = new Size(656, 428);
            HuyetHocT1.TabIndex = 0;
            HuyetHocT1.Text = "Huyết học T1";
            HuyetHocT1.UseVisualStyleBackColor = true;
            // 
            // label4
            // 
            label4.Anchor = AnchorStyles.Top | AnchorStyles.Right;
            label4.AutoSize = true;
            label4.Location = new Point(508, 12);
            label4.Name = "label4";
            label4.Size = new Size(68, 15);
            label4.TabIndex = 5;
            label4.Text = "Nhóm máu";
            // 
            // DataGST1
            // 
            DataGST1.AllowDrop = true;
            DataGST1.AllowUserToAddRows = false;
            DataGST1.AllowUserToDeleteRows = false;
            DataGST1.AllowUserToResizeRows = false;
            DataGST1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Right;
            DataGST1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataGST1.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataGST1.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn2, dataGridViewTextBoxColumn3 });
            DataGST1.EditMode = DataGridViewEditMode.EditOnEnter;
            DataGST1.Location = new Point(437, 37);
            DataGST1.Name = "DataGST1";
            DataGST1.RowHeadersVisible = false;
            DataGST1.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataGST1.Size = new Size(213, 385);
            DataGST1.TabIndex = 4;
            // 
            // dataGridViewTextBoxColumn2
            // 
            dataGridViewTextBoxColumn2.HeaderText = "STT";
            dataGridViewTextBoxColumn2.Name = "dataGridViewTextBoxColumn2";
            dataGridViewTextBoxColumn2.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn3
            // 
            dataGridViewTextBoxColumn3.HeaderText = "SID";
            dataGridViewTextBoxColumn3.Name = "dataGridViewTextBoxColumn3";
            // 
            // label2
            // 
            label2.Anchor = AnchorStyles.Top | AnchorStyles.Bottom;
            label2.AutoSize = true;
            label2.Location = new Point(275, 12);
            label2.Name = "label2";
            label2.Size = new Size(90, 15);
            label2.TabIndex = 3;
            label2.Text = "Công thức máu";
            // 
            // label1
            // 
            label1.AutoSize = true;
            label1.Location = new Point(77, 12);
            label1.Name = "label1";
            label1.Size = new Size(63, 15);
            label1.TabIndex = 2;
            label1.Text = "Đông máu";
            // 
            // DataDMT1
            // 
            DataDMT1.AllowDrop = true;
            DataDMT1.AllowUserToAddRows = false;
            DataDMT1.AllowUserToDeleteRows = false;
            DataDMT1.AllowUserToResizeRows = false;
            DataDMT1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left;
            DataDMT1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataDMT1.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataDMT1.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn1, SID1 });
            DataDMT1.EditMode = DataGridViewEditMode.EditOnEnter;
            DataDMT1.Location = new Point(6, 37);
            DataDMT1.Name = "DataDMT1";
            DataDMT1.RowHeadersVisible = false;
            DataDMT1.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataDMT1.Size = new Size(201, 385);
            DataDMT1.TabIndex = 1;
            // 
            // dataGridViewTextBoxColumn1
            // 
            dataGridViewTextBoxColumn1.HeaderText = "STT";
            dataGridViewTextBoxColumn1.Name = "dataGridViewTextBoxColumn1";
            dataGridViewTextBoxColumn1.ReadOnly = true;
            // 
            // SID1
            // 
            SID1.HeaderText = "SID";
            SID1.Name = "SID1";
            // 
            // DataCTMT1
            // 
            DataCTMT1.AllowDrop = true;
            DataCTMT1.AllowUserToAddRows = false;
            DataCTMT1.AllowUserToDeleteRows = false;
            DataCTMT1.AllowUserToResizeRows = false;
            DataCTMT1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom;
            DataCTMT1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataCTMT1.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataCTMT1.Columns.AddRange(new DataGridViewColumn[] { STT, SID });
            DataCTMT1.EditMode = DataGridViewEditMode.EditOnEnter;
            DataCTMT1.Location = new Point(210, 37);
            DataCTMT1.Name = "DataCTMT1";
            DataCTMT1.RowHeadersVisible = false;
            DataCTMT1.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataCTMT1.Size = new Size(223, 385);
            DataCTMT1.TabIndex = 0;
            // 
            // STT
            // 
            STT.HeaderText = "STT";
            STT.Name = "STT";
            STT.ReadOnly = true;
            // 
            // SID
            // 
            SID.HeaderText = "SID";
            SID.Name = "SID";
            // 
            // tabPage4
            // 
            tabPage4.Controls.Add(label7);
            tabPage4.Controls.Add(DataSHT1);
            tabPage4.Location = new Point(4, 24);
            tabPage4.Name = "tabPage4";
            tabPage4.Padding = new Padding(3);
            tabPage4.Size = new Size(656, 428);
            tabPage4.TabIndex = 1;
            tabPage4.Text = "Sinh hóa T1";
            tabPage4.UseVisualStyleBackColor = true;
            // 
            // label7
            // 
            label7.AutoSize = true;
            label7.Location = new Point(77, 9);
            label7.Name = "label7";
            label7.Size = new Size(53, 15);
            label7.TabIndex = 8;
            label7.Text = "Sinh hóa";
            // 
            // DataSHT1
            // 
            DataSHT1.AllowDrop = true;
            DataSHT1.AllowUserToAddRows = false;
            DataSHT1.AllowUserToDeleteRows = false;
            DataSHT1.AllowUserToResizeRows = false;
            DataSHT1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left;
            DataSHT1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataSHT1.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataSHT1.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn6, dataGridViewTextBoxColumn7 });
            DataSHT1.EditMode = DataGridViewEditMode.EditOnEnter;
            DataSHT1.Location = new Point(6, 34);
            DataSHT1.Name = "DataSHT1";
            DataSHT1.RowHeadersVisible = false;
            DataSHT1.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataSHT1.Size = new Size(201, 385);
            DataSHT1.TabIndex = 7;
            // 
            // dataGridViewTextBoxColumn6
            // 
            dataGridViewTextBoxColumn6.HeaderText = "STT";
            dataGridViewTextBoxColumn6.Name = "dataGridViewTextBoxColumn6";
            dataGridViewTextBoxColumn6.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn7
            // 
            dataGridViewTextBoxColumn7.HeaderText = "SID";
            dataGridViewTextBoxColumn7.Name = "dataGridViewTextBoxColumn7";
            // 
            // tabPage1
            // 
            tabPage1.Controls.Add(label10);
            tabPage1.Controls.Add(DataMDT1);
            tabPage1.Location = new Point(4, 24);
            tabPage1.Name = "tabPage1";
            tabPage1.Padding = new Padding(3);
            tabPage1.Size = new Size(656, 428);
            tabPage1.TabIndex = 2;
            tabPage1.Text = "Miễn dịch T1";
            tabPage1.UseVisualStyleBackColor = true;
            // 
            // label10
            // 
            label10.AutoSize = true;
            label10.Location = new Point(77, 9);
            label10.Name = "label10";
            label10.Size = new Size(60, 15);
            label10.TabIndex = 8;
            label10.Text = "Miễn dịch";
            // 
            // DataMDT1
            // 
            DataMDT1.AllowDrop = true;
            DataMDT1.AllowUserToAddRows = false;
            DataMDT1.AllowUserToDeleteRows = false;
            DataMDT1.AllowUserToResizeRows = false;
            DataMDT1.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left;
            DataMDT1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataMDT1.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataMDT1.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn12, dataGridViewTextBoxColumn13 });
            DataMDT1.EditMode = DataGridViewEditMode.EditOnEnter;
            DataMDT1.Location = new Point(6, 34);
            DataMDT1.Name = "DataMDT1";
            DataMDT1.RowHeadersVisible = false;
            DataMDT1.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataMDT1.Size = new Size(201, 385);
            DataMDT1.TabIndex = 7;
            // 
            // dataGridViewTextBoxColumn12
            // 
            dataGridViewTextBoxColumn12.HeaderText = "STT";
            dataGridViewTextBoxColumn12.Name = "dataGridViewTextBoxColumn12";
            dataGridViewTextBoxColumn12.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn13
            // 
            dataGridViewTextBoxColumn13.HeaderText = "SID";
            dataGridViewTextBoxColumn13.Name = "dataGridViewTextBoxColumn13";
            // 
            // tabPage3
            // 
            tabPage3.Controls.Add(label11);
            tabPage3.Controls.Add(DataGST3);
            tabPage3.Controls.Add(label12);
            tabPage3.Controls.Add(label13);
            tabPage3.Controls.Add(DataDMT3);
            tabPage3.Controls.Add(DataCTMT3);
            tabPage3.Location = new Point(4, 24);
            tabPage3.Name = "tabPage3";
            tabPage3.Padding = new Padding(3);
            tabPage3.Size = new Size(656, 428);
            tabPage3.TabIndex = 3;
            tabPage3.Text = "Huyết học T3";
            tabPage3.UseVisualStyleBackColor = true;
            // 
            // label11
            // 
            label11.Anchor = AnchorStyles.Top | AnchorStyles.Right;
            label11.AutoSize = true;
            label11.Location = new Point(508, 9);
            label11.Name = "label11";
            label11.Size = new Size(68, 15);
            label11.TabIndex = 11;
            label11.Text = "Nhóm máu";
            // 
            // DataGST3
            // 
            DataGST3.AllowDrop = true;
            DataGST3.AllowUserToAddRows = false;
            DataGST3.AllowUserToDeleteRows = false;
            DataGST3.AllowUserToResizeRows = false;
            DataGST3.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Right;
            DataGST3.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataGST3.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataGST3.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn16, dataGridViewTextBoxColumn17 });
            DataGST3.EditMode = DataGridViewEditMode.EditOnEnter;
            DataGST3.Location = new Point(437, 34);
            DataGST3.Name = "DataGST3";
            DataGST3.RowHeadersVisible = false;
            DataGST3.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataGST3.Size = new Size(213, 385);
            DataGST3.TabIndex = 10;
            // 
            // dataGridViewTextBoxColumn16
            // 
            dataGridViewTextBoxColumn16.HeaderText = "STT";
            dataGridViewTextBoxColumn16.Name = "dataGridViewTextBoxColumn16";
            dataGridViewTextBoxColumn16.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn17
            // 
            dataGridViewTextBoxColumn17.HeaderText = "SID";
            dataGridViewTextBoxColumn17.Name = "dataGridViewTextBoxColumn17";
            // 
            // label12
            // 
            label12.Anchor = AnchorStyles.Top | AnchorStyles.Bottom;
            label12.AutoSize = true;
            label12.Location = new Point(275, 9);
            label12.Name = "label12";
            label12.Size = new Size(90, 15);
            label12.TabIndex = 9;
            label12.Text = "Công thức máu";
            // 
            // label13
            // 
            label13.AutoSize = true;
            label13.Location = new Point(77, 9);
            label13.Name = "label13";
            label13.Size = new Size(63, 15);
            label13.TabIndex = 8;
            label13.Text = "Đông máu";
            // 
            // DataDMT3
            // 
            DataDMT3.AllowDrop = true;
            DataDMT3.AllowUserToAddRows = false;
            DataDMT3.AllowUserToDeleteRows = false;
            DataDMT3.AllowUserToResizeRows = false;
            DataDMT3.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left;
            DataDMT3.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataDMT3.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataDMT3.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn18, dataGridViewTextBoxColumn19 });
            DataDMT3.EditMode = DataGridViewEditMode.EditOnEnter;
            DataDMT3.Location = new Point(6, 34);
            DataDMT3.Name = "DataDMT3";
            DataDMT3.RowHeadersVisible = false;
            DataDMT3.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataDMT3.Size = new Size(201, 385);
            DataDMT3.TabIndex = 7;
            // 
            // dataGridViewTextBoxColumn18
            // 
            dataGridViewTextBoxColumn18.HeaderText = "STT";
            dataGridViewTextBoxColumn18.Name = "dataGridViewTextBoxColumn18";
            dataGridViewTextBoxColumn18.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn19
            // 
            dataGridViewTextBoxColumn19.HeaderText = "SID";
            dataGridViewTextBoxColumn19.Name = "dataGridViewTextBoxColumn19";
            // 
            // DataCTMT3
            // 
            DataCTMT3.AllowDrop = true;
            DataCTMT3.AllowUserToAddRows = false;
            DataCTMT3.AllowUserToDeleteRows = false;
            DataCTMT3.AllowUserToResizeRows = false;
            DataCTMT3.Anchor = AnchorStyles.Top | AnchorStyles.Bottom;
            DataCTMT3.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataCTMT3.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataCTMT3.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn20, dataGridViewTextBoxColumn21 });
            DataCTMT3.EditMode = DataGridViewEditMode.EditOnEnter;
            DataCTMT3.Location = new Point(210, 34);
            DataCTMT3.Name = "DataCTMT3";
            DataCTMT3.RowHeadersVisible = false;
            DataCTMT3.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataCTMT3.Size = new Size(223, 385);
            DataCTMT3.TabIndex = 6;
            // 
            // dataGridViewTextBoxColumn20
            // 
            dataGridViewTextBoxColumn20.HeaderText = "STT";
            dataGridViewTextBoxColumn20.Name = "dataGridViewTextBoxColumn20";
            dataGridViewTextBoxColumn20.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn21
            // 
            dataGridViewTextBoxColumn21.HeaderText = "SID";
            dataGridViewTextBoxColumn21.Name = "dataGridViewTextBoxColumn21";
            // 
            // tabPage5
            // 
            tabPage5.Controls.Add(label16);
            tabPage5.Controls.Add(DataSHMDT3);
            tabPage5.Location = new Point(4, 24);
            tabPage5.Name = "tabPage5";
            tabPage5.Padding = new Padding(3);
            tabPage5.Size = new Size(656, 428);
            tabPage5.TabIndex = 4;
            tabPage5.Text = "SH-MD T3";
            tabPage5.UseVisualStyleBackColor = true;
            // 
            // label16
            // 
            label16.AutoSize = true;
            label16.Location = new Point(77, 9);
            label16.Name = "label16";
            label16.Size = new Size(46, 15);
            label16.TabIndex = 8;
            label16.Text = "SH-MD";
            // 
            // DataSHMDT3
            // 
            DataSHMDT3.AllowDrop = true;
            DataSHMDT3.AllowUserToAddRows = false;
            DataSHMDT3.AllowUserToDeleteRows = false;
            DataSHMDT3.AllowUserToResizeRows = false;
            DataSHMDT3.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left;
            DataSHMDT3.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            DataSHMDT3.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            DataSHMDT3.Columns.AddRange(new DataGridViewColumn[] { dataGridViewTextBoxColumn24, dataGridViewTextBoxColumn25 });
            DataSHMDT3.EditMode = DataGridViewEditMode.EditOnEnter;
            DataSHMDT3.Location = new Point(6, 34);
            DataSHMDT3.Name = "DataSHMDT3";
            DataSHMDT3.RowHeadersVisible = false;
            DataSHMDT3.RowHeadersWidthSizeMode = DataGridViewRowHeadersWidthSizeMode.DisableResizing;
            DataSHMDT3.Size = new Size(201, 385);
            DataSHMDT3.TabIndex = 7;
            // 
            // dataGridViewTextBoxColumn24
            // 
            dataGridViewTextBoxColumn24.HeaderText = "STT";
            dataGridViewTextBoxColumn24.Name = "dataGridViewTextBoxColumn24";
            dataGridViewTextBoxColumn24.ReadOnly = true;
            // 
            // dataGridViewTextBoxColumn25
            // 
            dataGridViewTextBoxColumn25.HeaderText = "SID";
            dataGridViewTextBoxColumn25.Name = "dataGridViewTextBoxColumn25";
            // 
            // tabPage2
            // 
            tabPage2.Controls.Add(cboLine);
            tabPage2.Controls.Add(radNuocTieu);
            tabPage2.Controls.Add(dgvInput);
            tabPage2.Controls.Add(txtCarrier);
            tabPage2.Controls.Add(radPCD);
            tabPage2.Controls.Add(radXanhDuong);
            tabPage2.Controls.Add(radXanhLa);
            tabPage2.Controls.Add(radDo);
            tabPage2.Controls.Add(radDen);
            tabPage2.Controls.Add(radKhac);
            tabPage2.Controls.Add(btnGui);
            tabPage2.Controls.Add(txtNguoiNhan);
            tabPage2.Controls.Add(txtNguoiGui);
            tabPage2.Controls.Add(dgvGiaoNhan);
            tabPage2.Location = new Point(4, 24);
            tabPage2.Name = "tabPage2";
            tabPage2.Padding = new Padding(3);
            tabPage2.Size = new Size(667, 465);
            tabPage2.TabIndex = 1;
            tabPage2.Text = "Giao Nhận Mẫu";
            tabPage2.UseVisualStyleBackColor = true;
            // 
            // cboLine
            // 
            cboLine.FormattingEnabled = true;
            cboLine.Items.AddRange(new object[] { "T1->T3", "T3->T1" });
            cboLine.Location = new Point(34, 44);
            cboLine.Name = "cboLine";
            cboLine.Size = new Size(91, 23);
            cboLine.TabIndex = 14;
            // 
            // radNuocTieu
            // 
            radNuocTieu.AutoSize = true;
            radNuocTieu.Location = new Point(198, 270);
            radNuocTieu.Name = "radNuocTieu";
            radNuocTieu.Size = new Size(77, 19);
            radNuocTieu.TabIndex = 13;
            radNuocTieu.TabStop = true;
            radNuocTieu.Text = "Nước tiểu";
            radNuocTieu.UseVisualStyleBackColor = true;
            // 
            // dgvInput
            // 
            dgvInput.AllowUserToResizeColumns = false;
            dgvInput.AllowUserToResizeRows = false;
            dgvInput.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvInput.Location = new Point(27, 97);
            dgvInput.Name = "dgvInput";
            dgvInput.Size = new Size(153, 344);
            dgvInput.TabIndex = 12;
            // 
            // txtCarrier
            // 
            txtCarrier.Location = new Point(149, 44);
            txtCarrier.Name = "txtCarrier";
            txtCarrier.Size = new Size(89, 23);
            txtCarrier.TabIndex = 11;
            txtCarrier.Text = "Carrier";
            // 
            // radPCD
            // 
            radPCD.AutoSize = true;
            radPCD.Location = new Point(198, 305);
            radPCD.Name = "radPCD";
            radPCD.Size = new Size(48, 19);
            radPCD.TabIndex = 10;
            radPCD.TabStop = true;
            radPCD.Text = "PCĐ";
            radPCD.UseVisualStyleBackColor = true;
            // 
            // radXanhDuong
            // 
            radXanhDuong.AutoSize = true;
            radXanhDuong.Location = new Point(198, 236);
            radXanhDuong.Name = "radXanhDuong";
            radXanhDuong.Size = new Size(91, 19);
            radXanhDuong.TabIndex = 9;
            radXanhDuong.TabStop = true;
            radXanhDuong.Text = "Xanh Dương";
            radXanhDuong.UseVisualStyleBackColor = true;
            // 
            // radXanhLa
            // 
            radXanhLa.AutoSize = true;
            radXanhLa.Location = new Point(198, 200);
            radXanhLa.Name = "radXanhLa";
            radXanhLa.Size = new Size(67, 19);
            radXanhLa.TabIndex = 8;
            radXanhLa.TabStop = true;
            radXanhLa.Text = "Xanh Lá";
            radXanhLa.UseVisualStyleBackColor = true;
            // 
            // radDo
            // 
            radDo.AutoSize = true;
            radDo.Location = new Point(198, 166);
            radDo.Name = "radDo";
            radDo.Size = new Size(40, 19);
            radDo.TabIndex = 7;
            radDo.TabStop = true;
            radDo.Text = "Đỏ";
            radDo.UseVisualStyleBackColor = true;
            // 
            // radDen
            // 
            radDen.AutoSize = true;
            radDen.Location = new Point(198, 132);
            radDen.Name = "radDen";
            radDen.Size = new Size(46, 19);
            radDen.TabIndex = 6;
            radDen.TabStop = true;
            radDen.Text = "Đen";
            radDen.UseVisualStyleBackColor = true;
            // 
            // radKhac
            // 
            radKhac.AutoSize = true;
            radKhac.Location = new Point(198, 97);
            radKhac.Name = "radKhac";
            radKhac.Size = new Size(51, 19);
            radKhac.TabIndex = 5;
            radKhac.TabStop = true;
            radKhac.Text = "Khác";
            radKhac.UseVisualStyleBackColor = true;
            // 
            // btnGui
            // 
            btnGui.Location = new Point(198, 363);
            btnGui.Name = "btnGui";
            btnGui.Size = new Size(89, 78);
            btnGui.TabIndex = 4;
            btnGui.Text = "Gửi";
            btnGui.UseVisualStyleBackColor = true;
            // 
            // txtNguoiNhan
            // 
            txtNguoiNhan.Location = new Point(149, 15);
            txtNguoiNhan.Name = "txtNguoiNhan";
            txtNguoiNhan.Size = new Size(89, 23);
            txtNguoiNhan.TabIndex = 2;
            txtNguoiNhan.Text = "Người nhận";
            // 
            // txtNguoiGui
            // 
            txtNguoiGui.Location = new Point(34, 15);
            txtNguoiGui.Name = "txtNguoiGui";
            txtNguoiGui.Size = new Size(91, 23);
            txtNguoiGui.TabIndex = 1;
            txtNguoiGui.Text = "Người gửi";
            // 
            // dgvGiaoNhan
            // 
            dgvGiaoNhan.AllowUserToResizeColumns = false;
            dgvGiaoNhan.AllowUserToResizeRows = false;
            dgvGiaoNhan.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.AllCells;
            dgvGiaoNhan.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvGiaoNhan.Location = new Point(302, 6);
            dgvGiaoNhan.Name = "dgvGiaoNhan";
            dgvGiaoNhan.Size = new Size(359, 453);
            dgvGiaoNhan.TabIndex = 0;
            // 
            // txtSearch
            // 
            txtSearch.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;
            txtSearch.Location = new Point(273, 589);
            txtSearch.Name = "txtSearch";
            txtSearch.Size = new Size(100, 23);
            txtSearch.TabIndex = 4;
            // 
            // label3
            // 
            label3.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;
            label3.AutoSize = true;
            label3.Location = new Point(279, 564);
            label3.Name = "label3";
            label3.Size = new Size(76, 15);
            label3.TabIndex = 5;
            label3.Text = "Tìm kiếm SID";
            // 
            // btnExport
            // 
            btnExport.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;
            btnExport.Location = new Point(273, 518);
            btnExport.Name = "btnExport";
            btnExport.Size = new Size(98, 43);
            btnExport.TabIndex = 7;
            btnExport.Text = "Xuất dữ liệu";
            btnExport.UseVisualStyleBackColor = true;
            // 
            // dgvSearch
            // 
            dgvSearch.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvSearch.Location = new Point(390, 512);
            dgvSearch.Name = "dgvSearch";
            dgvSearch.Size = new Size(248, 106);
            dgvSearch.TabIndex = 12;
            // 
            // dgvChatAll
            // 
            dgvChatAll.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvChatAll.Location = new Point(12, 204);
            dgvChatAll.Name = "dgvChatAll";
            dgvChatAll.Size = new Size(247, 328);
            dgvChatAll.TabIndex = 13;
            // 
            // panel1
            // 
            panel1.Controls.Add(txtTaskSID);
            panel1.Controls.Add(dgvTask);
            panel1.Location = new Point(946, 49);
            panel1.Name = "panel1";
            panel1.Size = new Size(281, 453);
            panel1.TabIndex = 14;
            // 
            // txtTaskSID
            // 
            txtTaskSID.Location = new Point(69, 420);
            txtTaskSID.Name = "txtTaskSID";
            txtTaskSID.Size = new Size(151, 23);
            txtTaskSID.TabIndex = 1;
            // 
            // dgvTask
            // 
            dgvTask.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvTask.Location = new Point(3, 3);
            dgvTask.Name = "dgvTask";
            dgvTask.Size = new Size(275, 411);
            dgvTask.TabIndex = 0;
            // 
            // cboKhuVuc
            // 
            cboKhuVuc.FormattingEnabled = true;
            cboKhuVuc.Items.AddRange(new object[] { "Hành Chánh T1", "Hành Chánh T3", "Huyết học T1", "Sinh hóa T1", "Miễn dịch T1", "Huyết học T3", "SH-MD T3", "Admin", "Khách" });
            cboKhuVuc.Location = new Point(997, 20);
            cboKhuVuc.Name = "cboKhuVuc";
            cboKhuVuc.Size = new Size(205, 23);
            cboKhuVuc.TabIndex = 15;
            // 
            // txtChatContent
            // 
            txtChatContent.Location = new Point(14, 538);
            txtChatContent.Name = "txtChatContent";
            txtChatContent.Size = new Size(183, 23);
            txtChatContent.TabIndex = 16;
            // 
            // cboChatTarget
            // 
            cboChatTarget.FormattingEnabled = true;
            cboChatTarget.Location = new Point(14, 14);
            cboChatTarget.Name = "cboChatTarget";
            cboChatTarget.Size = new Size(245, 23);
            cboChatTarget.TabIndex = 17;
            // 
            // dgvChatPrivate
            // 
            dgvChatPrivate.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.AutoSize;
            dgvChatPrivate.Location = new Point(13, 46);
            dgvChatPrivate.Name = "dgvChatPrivate";
            dgvChatPrivate.Size = new Size(247, 152);
            dgvChatPrivate.TabIndex = 18;
            // 
            // btnChatSend
            // 
            btnChatSend.Location = new Point(203, 538);
            btnChatSend.Name = "btnChatSend";
            btnChatSend.Size = new Size(57, 23);
            btnChatSend.TabIndex = 19;
            btnChatSend.Text = "Gửi";
            btnChatSend.UseVisualStyleBackColor = true;
            // 
            // btnClearData
            // 
            btnClearData.Location = new Point(652, 514);
            btnClearData.Name = "btnClearData";
            btnClearData.Size = new Size(121, 44);
            btnClearData.TabIndex = 20;
            btnClearData.Text = "Xóa dữ liệu";
            btnClearData.UseVisualStyleBackColor = true;
            // 
            // Form1
            // 
            AutoScaleDimensions = new SizeF(7F, 15F);
            AutoScaleMode = AutoScaleMode.Font;
            ClientSize = new Size(1241, 624);
            Controls.Add(btnClearData);
            Controls.Add(btnChatSend);
            Controls.Add(dgvChatPrivate);
            Controls.Add(cboChatTarget);
            Controls.Add(txtChatContent);
            Controls.Add(cboKhuVuc);
            Controls.Add(panel1);
            Controls.Add(dgvChatAll);
            Controls.Add(dgvSearch);
            Controls.Add(btnExport);
            Controls.Add(label3);
            Controls.Add(txtSearch);
            Controls.Add(tabControl1);
            Name = "Form1";
            Text = "Lưu Mẫu";
            Load += Form1_Load;
            tabControl1.ResumeLayout(false);
            LuuMau.ResumeLayout(false);
            tabControl2.ResumeLayout(false);
            HuyetHocT1.ResumeLayout(false);
            HuyetHocT1.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)DataGST1).EndInit();
            ((System.ComponentModel.ISupportInitialize)DataDMT1).EndInit();
            ((System.ComponentModel.ISupportInitialize)DataCTMT1).EndInit();
            tabPage4.ResumeLayout(false);
            tabPage4.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)DataSHT1).EndInit();
            tabPage1.ResumeLayout(false);
            tabPage1.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)DataMDT1).EndInit();
            tabPage3.ResumeLayout(false);
            tabPage3.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)DataGST3).EndInit();
            ((System.ComponentModel.ISupportInitialize)DataDMT3).EndInit();
            ((System.ComponentModel.ISupportInitialize)DataCTMT3).EndInit();
            tabPage5.ResumeLayout(false);
            tabPage5.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)DataSHMDT3).EndInit();
            tabPage2.ResumeLayout(false);
            tabPage2.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)dgvInput).EndInit();
            ((System.ComponentModel.ISupportInitialize)dgvGiaoNhan).EndInit();
            ((System.ComponentModel.ISupportInitialize)dgvSearch).EndInit();
            ((System.ComponentModel.ISupportInitialize)dgvChatAll).EndInit();
            panel1.ResumeLayout(false);
            panel1.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)dgvTask).EndInit();
            ((System.ComponentModel.ISupportInitialize)dgvChatPrivate).EndInit();
            ResumeLayout(false);
            PerformLayout();
        }

        #endregion
        private TabControl tabControl1;
        private TabPage LuuMau;
        private TabPage tabPage2;
        private TabControl tabControl2;
        private TabPage HuyetHocT1;
        private TabPage tabPage4;
        private DataGridViewTextBoxColumn SID;
        private DataGridViewTextBoxColumn STT;
        private DataGridView DataCTMT1;
        private DataGridView DataDMT1;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn1;
        private DataGridViewTextBoxColumn SID1;
        private Label label1;
        private TextBox txtSearch;
        private Label label2;
        private Label label3;
        private Button btnExport;
        private Label label4;
        private DataGridView DataGST1;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn2;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn3;
        private TabPage tabPage1;
        private TabPage tabPage3;
        private TabPage tabPage5;
        private Label label7;
        private DataGridView DataSHT1;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn6;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn7;
        private Label label10;
        private DataGridView DataMDT1;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn12;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn13;
        private Label label11;
        private DataGridView DataGST3;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn16;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn17;
        private Label label12;
        private Label label13;
        private DataGridView DataDMT3;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn18;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn19;
        private DataGridView DataCTMT3;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn20;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn21;
        private Label label16;
        private DataGridView DataSHMDT3;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn24;
        private DataGridViewTextBoxColumn dataGridViewTextBoxColumn25;
        private DataGridView dgvSearch;
        private DataGridView dgvGiaoNhan;
        private DataGridView dgvChatAll;
        private TextBox txtNguoiNhan;
        private TextBox txtNguoiGui;
        private RadioButton radXanhDuong;
        private RadioButton radXanhLa;
        private RadioButton radDo;
        private RadioButton radDen;
        private RadioButton radKhac;
        private Button btnGui;
        private DataGridView dgvInput;
        private TextBox txtCarrier;
        private RadioButton radPCD;
        private RadioButton radNuocTieu;
        private ComboBox cboLine;
        private Panel panel1;
        private ComboBox cboKhuVuc;
        private TextBox txtTaskSID;
        private DataGridView dgvTask;
        private TextBox txtChatContent;
        private ComboBox cboChatTarget;
        private DataGridView dgvChatPrivate;
        private Button btnChatSend;
        private Button btnClearData;
    }
}



==========================================
FILE: Form1.Lab.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Lab.cs
==========================================
using System.Threading.Tasks;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1
    {
        private LabDataContext _context;

        private void SetupLabSystem(FirebaseService firebase)
        {
            _context = new LabDataContext(firebase);

            // Tầng 1
            if (DataCTMT1 != null) _context.RegisterTable(DataCTMT1, "T1_HuyetHoc_CongThucMau");
            if (DataDMT1 != null) _context.RegisterTable(DataDMT1, "T1_HuyetHoc_DongMau");
            if (DataGST1 != null) _context.RegisterTable(DataGST1, "T1_HuyetHoc_GiamSat");
            if (DataSHT1 != null) _context.RegisterTable(DataSHT1, "T1_SinhHoa");
            if (DataMDT1 != null) _context.RegisterTable(DataMDT1, "T1_MienDich");

            // Tầng 3
            if (DataCTMT3 != null) _context.RegisterTable(DataCTMT3, "T3_HuyetHoc_CongThucMau");
            if (DataDMT3 != null) _context.RegisterTable(DataDMT3, "T3_HuyetHoc_DongMau");
            if (DataGST3 != null) _context.RegisterTable(DataGST3, "T3_HuyetHoc_GiamSat");
            if (DataSHMDT3 != null) _context.RegisterTable(DataSHMDT3, "T3_SinhHoa_MienDich");
        }

        private async Task StartLabSyncAsync()
        {
            if (_context != null) await _context.StartAllAsync();
        }
    }
}



==========================================
FILE: Form1.Logistics.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Logistics.cs
==========================================
using System.Threading.Tasks;
using UBCS2_A.Helpers;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1
    {
        private LogisticsContext _logisticsContext;
        private MatrixManager _matrixManager;
        private InputGroupManager _inputGroupManager;

        private void SetupLogisticsSystem(FirebaseService firebase)
        {
            _logisticsContext = new LogisticsContext(firebase);

            if (dgvGiaoNhan != null)
            {
                // 1. Setup Matrix
                _matrixManager = new MatrixManager(dgvGiaoNhan);
                _logisticsContext.RegisterMatrixTable(_matrixManager, "T_Logistics_Matrix");

                // 2. Setup Input Group (Nhập liệu)
                if (dgvInput != null && btnGui != null)
                {
                    _inputGroupManager = new InputGroupManager(
                        _matrixManager, dgvInput, btnGui,
                        txtNguoiGui, txtNguoiNhan, txtCarrier, cboLine,
                        radKhac, radDen, radDo, radXanhLa, radXanhDuong, radNuocTieu, radPCD
                    );
                }
            }
        }

        private async Task StartLogisticsSyncAsync()
        {
            if (_logisticsContext != null)
            {
                _logisticsContext.PrepareSync();
                await _logisticsContext.LoadInitialDataAsync();
            }
        }
    }
}



==========================================
FILE: Form1.Search.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Search.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Helpers;
using UBCS2_A.Models;

namespace UBCS2_A
{
    public partial class Form1
    {
        private SearchManager _searchManager;

        private void SetupSearchSystem()
        {
            if (dgvSearch != null && txtSearch != null)
            {
                _searchManager = new SearchManager(dgvSearch);
                _searchManager.OnResultSelected += HandleSearchResultSelection;
                txtSearch.KeyDown += TxtSearch_KeyDown;
            }
        }

        private void TxtSearch_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                string keyword = txtSearch.Text.Trim();
                if (string.IsNullOrEmpty(keyword)) return;

                var finalResults = new List<SearchResultModel>();

                // 1. Tìm trong Logistics
                if (_matrixManager != null)
                    finalResults.AddRange(_matrixManager.FindSidWithLocation(keyword));

                // 2. Tìm trong Lab (9 bảng)
                if (_context != null)
                    finalResults.AddRange(_context.GetSearchResultsWithLocation(keyword));

                if (finalResults.Count == 0)
                {
                    finalResults.Add(new SearchResultModel()
                    {
                        DisplayText = $"Không tìm thấy '{keyword}'",
                        BackColor = Color.WhiteSmoke
                    });
                }

                _searchManager.ShowResults(finalResults);
                e.SuppressKeyPress = true;
                txtSearch.SelectAll();
            }
        }

        private void HandleSearchResultSelection(SearchResultModel result)
        {
            if (result == null || result.TargetGrid == null) return;

            var grid = result.TargetGrid;

            // =========================================================================
            // [MỚI] SỬ DỤNG EXTENSION METHOD - CODE CỰC GỌN!
            // =========================================================================
            // Thay vì viết vòng lặp while dài dòng, ta chỉ cần gọi:
            grid.FocusOnTab();
            // =========================================================================

            // Xử lý cuộn và tô màu (Logic nghiệp vụ giữ nguyên)
            try
            {
                if (result.RowIndex >= 0 && result.RowIndex < grid.RowCount)
                {
                    grid.ClearSelection();

                    // 1. Cuộn màn hình đến dòng đó
                    grid.FirstDisplayedScrollingRowIndex = result.RowIndex;

                    // 2. Đặt con trỏ vào đúng ô SID (Cột 1)
                    if (result.ColIndex >= 0 && result.ColIndex < grid.ColumnCount)
                    {
                        grid.CurrentCell = grid.Rows[result.RowIndex].Cells[result.ColIndex];
                        grid.Rows[result.RowIndex].Cells[result.ColIndex].Selected = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[NAV-ERR] Lỗi điều hướng: {ex.Message}");
            }
        }
    }
}



==========================================
FILE: Form1.Task.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Task.cs
==========================================
using System.Threading.Tasks;
using UBCS2_A.Helpers;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1
    {
        private TaskContext _taskContext;
        private TaskManager _taskManager;

        private void SetupTaskSystem(FirebaseService firebase)
        {
            _taskContext = new TaskContext(firebase);

            if (dgvTask != null && txtTaskSID != null)
            {
                _taskContext.RegisterTaskTable(dgvTask, "T_Tasks", 100);
                _taskManager = new TaskManager(txtTaskSID, _taskContext);
            }
        }

        private async Task StartTaskSyncAsync()
        {
            if (_taskContext != null)
            {
                _taskContext.StartSync();
                await _taskContext.LoadInitialDataAsync();
            }
        }
    }
}



==========================================
FILE: Form1.Update.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Form1.Update.cs
==========================================
using System;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Models;
using UBCS2_A.Services;

namespace UBCS2_A
{
    public partial class Form1
    {
        // Định nghĩa phiên bản hiện tại của App (Bạn nhớ sửa số này mỗi khi build bản mới)
        private const string CURRENT_VERSION = "1.0.0";

        /// <summary>
        /// Hàm kiểm tra cập nhật (Chạy ngầm).
        /// </summary>
        private async Task CheckForUpdatesAsync(FirebaseService firebase)
        {
            try
            {
                Console.WriteLine("[UPDATE] 🔄 Đang kiểm tra phiên bản mới...");

                // 1. Lấy thông tin từ node "SystemInfo" trên Firebase
                // (Dựa vào SystemInfoModel.cs bạn đã có)
                var info = await firebase.GetDataAsync<SystemInfoModel>("SystemInfo");

                if (info != null && !string.IsNullOrEmpty(info.Version))
                {
                    // 2. So sánh phiên bản
                    // (Logic đơn giản: Khác nhau là báo update. Có thể nâng cấp lên so sánh lớn hơn/nhỏ hơn sau)
                    if (info.Version != CURRENT_VERSION)
                    {
                        Console.WriteLine($"[UPDATE] 🚀 Phát hiện bản mới: {info.Version} (Hiện tại: {CURRENT_VERSION})");

                        string msg = $"Đã có phiên bản mới: {info.Version}\n" +
                                     $"Phiên bản hiện tại: {CURRENT_VERSION}\n\n" +
                                     "Bạn có muốn tải về cập nhật ngay không?";

                        // Hiện Popup hỏi người dùng (Chạy trên UI Thread)
                        if (MessageBox.Show(msg, "Cập nhật phần mềm", MessageBoxButtons.YesNo, MessageBoxIcon.Information) == DialogResult.Yes)
                        {
                            // 3. Mở trình duyệt tải về
                            if (!string.IsNullOrEmpty(info.DownloadUrl))
                            {
                                Process.Start(new ProcessStartInfo
                                {
                                    FileName = info.DownloadUrl,
                                    UseShellExecute = true // Quan trọng để mở link trên trình duyệt mặc định
                                });

                                // 4. Đóng App để người dùng cài đặt
                                Application.Exit();
                            }
                            else
                            {
                                MessageBox.Show("Link tải bị lỗi. Vui lòng liên hệ Admin.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }
                    }
                    else
                    {
                        Console.WriteLine("[UPDATE] ✅ Phần mềm đang là phiên bản mới nhất.");
                    }
                }
            }
            catch (Exception ex)
            {
                // Lỗi update không nên làm crash app, chỉ log ra thôi
                Console.WriteLine($"[UPDATE-ERR] ❌ Lỗi kiểm tra cập nhật: {ex.Message}");
            }
        }
    }
}



==========================================
FILE: Program.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Program.cs
==========================================
using System;
using System.Windows.Forms;

namespace UBCS2_A
{
    internal static class Program
    {
        [STAThread]
        static void Main()
        {
            ApplicationConfiguration.Initialize();
            Application.Run(new Form1());
        }
    }
}



==========================================
FILE: ChatManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\ChatManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [MANAGER] Quản lý giao diện Chat.
    /// - [UPDATE] Font size = 9 (Nhỏ gọn).
    /// - [KEEP] Viết tắt tên (HH.T1, SH.T1...).
    /// - [KEEP] Logic tách biệt T1/T3.
    /// </summary>
    public class ChatManager
    {
        // --- UI CONTROLS ---
        private readonly DataGridView _dgvAll;
        private readonly DataGridView _dgvPrivate;

        // --- LOGIC HELPERS ---
        private GridManager<ChatModel> _gridMgrAll;
        private GridManager<ChatModel> _gridMgrPrivate;

        // --- DATA ---
        private List<ChatModel> _allChats = new List<ChatModel>();
        private List<ChatModel> _filteredChats = new List<ChatModel>();

        // --- STATE ---
        private string _currentUserRole = "Khách";

        public ChatManager(DataGridView dgvAll, DataGridView dgvPrivate)
        {
            _dgvAll = dgvAll;
            _dgvPrivate = dgvPrivate;

            Console.WriteLine("[CHAT-MGR] 🟢 Khởi tạo Chat Manager (Small Font).");
            SetupGrid(_dgvAll);
            SetupGrid(_dgvPrivate);
        }

        #region 1. CẤU HÌNH GIAO DIỆN (SIZE 9)

        private void SetupGrid(DataGridView dgv)
        {
            dgv.AutoGenerateColumns = false;
            dgv.Columns.Clear();
            dgv.BackgroundColor = Color.White;
            dgv.RowHeadersVisible = false;

            dgv.AllowUserToAddRows = false;
            dgv.AllowUserToDeleteRows = false;
            dgv.AllowUserToResizeRows = false;
            dgv.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dgv.CellBorderStyle = DataGridViewCellBorderStyle.None;

            dgv.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.DisplayedCells;
            dgv.ColumnHeadersVisible = false;

            // Cột Nội Dung
            var colMessage = new DataGridViewTextBoxColumn()
            {
                Name = "colMessage",
                HeaderText = "Nội Dung",
                ReadOnly = true,
                AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
            };

            colMessage.DefaultCellStyle.WrapMode = DataGridViewTriState.True;

            // Giữ padding nhỏ để tiết kiệm diện tích
            colMessage.DefaultCellStyle.Padding = new Padding(2, 1, 2, 1);

            // [UPDATE] Giảm Font size xuống 9
            colMessage.DefaultCellStyle.Font = new Font("Segoe UI", 9, FontStyle.Regular);

            dgv.Columns.Add(colMessage);

            dgv.CellFormatting += Dgv_CellFormatting;
        }

        private void Dgv_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            DataGridView dgv = sender as DataGridView;
            var sourceList = (dgv == _dgvAll) ? _allChats : _filteredChats;

            if (e.RowIndex >= 0 && e.RowIndex < sourceList.Count)
            {
                var chat = sourceList[e.RowIndex];

                // Tô màu nền
                Color bgColor = Color.WhiteSmoke;

                if (string.Equals(chat.NoiNhan, "Toàn viện", StringComparison.OrdinalIgnoreCase))
                    bgColor = Color.White;
                else if (chat.NoiNhan.Contains("Huyết học")) bgColor = Color.MistyRose;
                else if (chat.NoiNhan.Contains("Sinh hóa")) bgColor = Color.Honeydew;
                else if (chat.NoiNhan.Contains("Miễn dịch")) bgColor = Color.AliceBlue;
                else if (chat.NoiNhan.Contains("Hành Chánh")) bgColor = Color.LemonChiffon;

                e.CellStyle.BackColor = bgColor;
                e.CellStyle.SelectionBackColor = bgColor;
                e.CellStyle.SelectionForeColor = Color.Black;
            }
        }

        #endregion

        #region 2. XỬ LÝ DỮ LIỆU & FORMATTING

        public void LoadData(List<ChatModel> allChats)
        {
            _allChats = allChats;

            // --- Grid Tổng ---
            if (_gridMgrAll == null)
            {
                _gridMgrAll = new GridManager<ChatModel>(_dgvAll, 1000);
                _gridMgrAll.OnGetValue = (r, m, c) => GetFormattedString(m);
            }

            var dictAll = new Dictionary<int, ChatModel>();
            for (int i = 0; i < _allChats.Count; i++) dictAll[i] = _allChats[i];

            _gridMgrAll.LoadFullData(dictAll);
            _dgvAll.RowCount = _allChats.Count;
            if (_allChats.Count > 0) _dgvAll.FirstDisplayedScrollingRowIndex = _allChats.Count - 1;

            // --- Grid Riêng ---
            ApplyFilter();
        }

        public void SetCurrentUserRole(string role)
        {
            _currentUserRole = role;
            ApplyFilter();
        }

        private void ApplyFilter()
        {
            _filteredChats.Clear();

            foreach (var chat in _allChats)
            {
                // Loại bỏ "Toàn viện"
                bool isGlobal = string.Equals(chat.NoiNhan, "Toàn viện", StringComparison.OrdinalIgnoreCase);
                if (isGlobal) continue;

                // Logic riêng biệt T1/T3
                bool isForMe = string.Equals(chat.NoiNhan, _currentUserRole, StringComparison.OrdinalIgnoreCase);
                bool isFromMe = string.Equals(chat.NguoiGui, _currentUserRole, StringComparison.OrdinalIgnoreCase);

                if (isForMe || isFromMe)
                {
                    _filteredChats.Add(chat);
                }
            }

            if (_gridMgrPrivate == null)
            {
                _gridMgrPrivate = new GridManager<ChatModel>(_dgvPrivate, 1000);
                _gridMgrPrivate.OnGetValue = (r, m, c) => GetFormattedString(m);
            }

            var dictFilter = new Dictionary<int, ChatModel>();
            for (int i = 0; i < _filteredChats.Count; i++) dictFilter[i] = _filteredChats[i];

            _gridMgrPrivate.LoadFullData(dictFilter);
            _dgvPrivate.RowCount = _filteredChats.Count;

            if (_filteredChats.Count > 0) _dgvPrivate.FirstDisplayedScrollingRowIndex = _filteredChats.Count - 1;
        }

        private string GetFormattedString(ChatModel m)
        {
            if (m == null || string.IsNullOrEmpty(m.NguoiGui)) return "";

            string shortSender = AbbreviateName(m.NguoiGui);
            string shortTarget = AbbreviateName(m.NoiNhan);

            return $"[{m.ThoiGian}] {shortSender}➔{shortTarget}: {m.NoiDung}";
        }

        private string AbbreviateName(string fullName)
        {
            if (string.IsNullOrEmpty(fullName)) return "";

            if (fullName.Equals("Toàn viện", StringComparison.OrdinalIgnoreCase)) return "ALL";
            if (fullName.Equals("Khách", StringComparison.OrdinalIgnoreCase)) return "Guest";

            string shortName = fullName
                .Replace("Huyết học", "HH")
                .Replace("Sinh hóa", "SH")
                .Replace("Miễn dịch", "MD")
                .Replace("Hành Chánh", "HC")
                .Replace("SH-MD", "SHMD")
                .Replace(" ", ".");

            return shortName;
        }

        #endregion
    }
}



==========================================
FILE: FlashTaskForm.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\FlashTaskForm.cs
==========================================
using System;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [UI] Form thông báo khẩn cấp (Popup).
    /// Đặc điểm: Luôn nổi lên trên (TopMost), nền nhấp nháy (Flashing).
    /// </summary>
    public class FlashTaskForm : Form
    {
        private System.Windows.Forms.Timer _flashTimer;
        private bool _isRed = false; // Biến cờ để đổi màu
        private TaskModel _task;

        // Sự kiện trả về khi bấm nút "Đã Nhận"
        public event Action<TaskModel> OnConfirm;

        public FlashTaskForm(TaskModel task)
        {
            _task = task;

            // 1. Cấu hình Form "Báo Động"
            this.Text = "⚠️ CÓ NHIỆM VỤ MỚI!";
            this.Size = new Size(400, 200);
            this.StartPosition = FormStartPosition.CenterScreen; // Hiện giữa màn hình
            this.FormBorderStyle = FormBorderStyle.FixedToolWindow; // Khung viền nhỏ, không nút Min/Max
            this.TopMost = true; // [QUAN TRỌNG] Luôn hiện trên cùng các cửa sổ khác
            this.ShowInTaskbar = false; // Không cần hiện dưới thanh taskbar

            InitializeUI();
            StartFlashing();
        }

        private void InitializeUI()
        {
            // Label hiển thị thông tin to rõ
            var lblInfo = new Label()
            {
                Text = $"MÃ SID: {_task.SID}\n\nNội dung: {_task.NoiDung}",
                Font = new Font("Segoe UI", 12, FontStyle.Bold),
                ForeColor = Color.Black,
                AutoSize = false,
                TextAlign = ContentAlignment.MiddleCenter,
                Dock = DockStyle.Top,
                Height = 100
            };
            this.Controls.Add(lblInfo);

            // Nút Xác nhận "ĐÃ NHẬN"
            var btnOk = new Button()
            {
                Text = "ĐÃ NHẬN (OK)",
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                Height = 40,
                Width = 150,
                BackColor = Color.Gold,
                Cursor = Cursors.Hand,
                Location = new Point((this.ClientSize.Width - 150) / 2, 110) // Căn giữa
            };

            btnOk.Click += (s, e) =>
            {
                _flashTimer.Stop(); // Dừng chớp
                OnConfirm?.Invoke(_task); // Gọi sự kiện ra ngoài Context xử lý
                this.Close(); // Đóng form
            };
            this.Controls.Add(btnOk);
        }

        private void StartFlashing()
        {
            // Timer để tạo hiệu ứng chớp chớp
            _flashTimer = new System.Windows.Forms.Timer();
            _flashTimer.Interval = 500; // Chớp mỗi 0.5 giây
            _flashTimer.Tick += (s, e) =>
            {
                // Đổi màu nền luân phiên: Đỏ nhạt <-> Trắng
                if (_isRed) this.BackColor = Color.White;
                else this.BackColor = Color.LightPink;

                _isRed = !_isRed;
            };
            _flashTimer.Start();
        }
    }
}



==========================================
FILE: GridManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\GridManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Reflection;
using System.Windows.Forms;
using Newtonsoft.Json.Linq;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [BASE CLASS] Quản lý DataGridView cơ bản.
    /// Nhiệm vụ: Virtual Mode, Edit, Copy/Paste, Batch Update.
    /// KHÔNG chứa logic nghiệp vụ (như tô màu trùng).
    /// </summary>
    public class GridManager<T> where T : class, new()
    {
        protected readonly DataGridView _dgv;
        protected T[] _dataSnapshot;
        protected readonly object _lock = new object();
        protected int _maxRows;

        // Batch Update
        protected bool _isBatchUpdating = false;
        protected HashSet<int> _dirtyRows = new HashSet<int>();

        // Delegates
        public Func<int, T, int, object> OnGetValue;
        public Action<T, int, object> OnSetValue;
        public event Action<int, T> OnUserChangedData;

        public GridManager(DataGridView dgv, int maxRows)
        {
            _dgv = dgv;
            _maxRows = maxRows;

            _dataSnapshot = new T[_maxRows];
            for (int i = 0; i < _maxRows; i++) _dataSnapshot[i] = new T();

            SetupBaseGrid();
        }

        private void SetupBaseGrid()
        {
            _dgv.VirtualMode = true;
            _dgv.RowCount = _maxRows;
            _dgv.EditMode = DataGridViewEditMode.EditOnKeystrokeOrF2;
            _dgv.ClipboardCopyMode = DataGridViewClipboardCopyMode.EnableWithoutHeaderText;

            EnableDoubleBuffering(_dgv);
            _dgv.DataError += (s, e) => { e.ThrowException = false; };

            _dgv.CellValueNeeded += Dgv_CellValueNeeded;
            _dgv.CellValuePushed += Dgv_CellValuePushed;
            _dgv.CellFormatting += Dgv_CellFormatting;
            _dgv.KeyDown += Dgv_KeyDown;
        }

        // --- CÁC HÀM VIRTUAL (ĐỂ CON GHI ĐÈ) ---

        // Hook: Khi dữ liệu thay đổi (để con tính toán lại, VD: tính trùng)
        protected virtual void OnDataSnapshotChanged() { }

        // Hook: Khi vẽ cell (để con tô màu)
        protected virtual void OnCustomCellFormatting(DataGridViewCellFormattingEventArgs e, T item, int rowIndex) { }

        // ---------------------------------------

        public void UpdateSingleRow(int rowIndex, JToken data)
        {
            if (rowIndex < 0 || rowIndex >= _maxRows) return;
            lock (_lock)
            {
                var updatedItem = data.ToObject<T>();
                if (updatedItem != null) _dataSnapshot[rowIndex] = updatedItem;
                OnDataSnapshotChanged();
            }
            if (_dgv.IsHandleCreated && !_dgv.IsDisposed)
                _dgv.BeginInvoke((Action)(() => { if (_dgv.RowCount > rowIndex) _dgv.InvalidateRow(rowIndex); }));
        }

        public void ClearAll()
        {
            lock (_lock)
            {
                for (int i = 0; i < _maxRows; i++) _dataSnapshot[i] = new T();
                OnDataSnapshotChanged();
            }
            if (_dgv.IsHandleCreated) _dgv.BeginInvoke((Action)(() => _dgv.Invalidate()));
        }

        public void LoadFullData(IDictionary<int, T> dataMap)
        {
            lock (_lock)
            {
                for (int i = 0; i < _maxRows; i++) _dataSnapshot[i] = new T();
                foreach (var kvp in dataMap) if (kvp.Key < _maxRows) _dataSnapshot[kvp.Key] = kvp.Value;
                OnDataSnapshotChanged();
            }
            if (_dgv.InvokeRequired) _dgv.Invoke(new Action(() => _dgv.Invalidate()));
            else _dgv.Invalidate();
        }

        // --- Event Handlers ---

        private void Dgv_CellValueNeeded(object sender, DataGridViewCellValueEventArgs e)
        {
            if (e.RowIndex < _maxRows && OnGetValue != null)
                e.Value = OnGetValue(e.RowIndex, _dataSnapshot[e.RowIndex], e.ColumnIndex);
        }

        private void Dgv_CellValuePushed(object sender, DataGridViewCellValueEventArgs e)
        {
            if (e.RowIndex < _maxRows && OnSetValue != null)
            {
                OnSetValue(_dataSnapshot[e.RowIndex], e.ColumnIndex, e.Value);
                OnDataSnapshotChanged();
                _dgv.InvalidateRow(e.RowIndex);

                if (!_isBatchUpdating) OnUserChangedData?.Invoke(e.RowIndex, _dataSnapshot[e.RowIndex]);
                else lock (_lock) { _dirtyRows.Add(e.RowIndex); }
            }
        }

        private void Dgv_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < _maxRows)
            {
                // Gọi hàm ảo để lớp con tự quyết định
                OnCustomCellFormatting(e, _dataSnapshot[e.RowIndex], e.RowIndex);
            }
        }

        private void Dgv_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.V) { PasteFromClipboard(); e.Handled = true; }
            else if (e.KeyCode == Keys.Delete) { DeleteSelectedCells(); e.Handled = true; }
        }

        private void PasteFromClipboard()
        {
            try
            {
                string s = Clipboard.GetText(); if (string.IsNullOrEmpty(s)) return;
                string[] lines = s.Split(new[] { "\r\n", "\n" }, StringSplitOptions.None);
                int startRow = _dgv.CurrentCell.RowIndex;
                int startCol = _dgv.CurrentCell.ColumnIndex;
                BeginBatchUpdate();
                for (int i = 0; i < lines.Length; i++)
                {
                    string[] cells = lines[i].Split('\t');
                    int currentRow = startRow + i;
                    if (currentRow >= _maxRows) break;
                    for (int j = 0; j < cells.Length; j++)
                    {
                        int currentCol = startCol + j;
                        if (currentCol >= _dgv.ColumnCount) break;
                        string val = cells[j].Trim();
                        if (i == lines.Length - 1 && string.IsNullOrEmpty(val)) continue;
                        if (OnSetValue != null)
                        {
                            OnSetValue(_dataSnapshot[currentRow], currentCol, val);
                            lock (_lock) { _dirtyRows.Add(currentRow); }
                        }
                    }
                }
                EndBatchUpdate();
            }
            catch { }
        }

        private void DeleteSelectedCells()
        {
            if (_dgv.SelectedCells.Count == 0) return;
            BeginBatchUpdate();
            foreach (DataGridViewCell cell in _dgv.SelectedCells)
            {
                if (!cell.ReadOnly && OnSetValue != null)
                {
                    OnSetValue(_dataSnapshot[cell.RowIndex], cell.ColumnIndex, "");
                    lock (_lock) { _dirtyRows.Add(cell.RowIndex); }
                }
            }
            EndBatchUpdate();
        }

        public void BeginBatchUpdate() { _isBatchUpdating = true; _dirtyRows.Clear(); }

        public void EndBatchUpdate()
        {
            _isBatchUpdating = false;
            foreach (int r in _dirtyRows) OnUserChangedData?.Invoke(r, _dataSnapshot[r]);
            _dirtyRows.Clear();
            OnDataSnapshotChanged();
            _dgv.Invalidate();
        }

        public void SearchAndHighlight(Func<T, bool> predicate)
        {
            int foundIndex = -1;
            lock (_lock) { for (int i = 0; i < _maxRows; i++) if (predicate(_dataSnapshot[i])) { foundIndex = i; break; } }
            if (foundIndex != -1) _dgv.BeginInvoke((Action)(() => {
                _dgv.ClearSelection();
                _dgv.FirstDisplayedScrollingRowIndex = foundIndex;
                _dgv.Rows[foundIndex].Selected = true;
            }));
        }

        public List<T> GetAllData() { lock (_lock) { return _dataSnapshot.ToList(); } }

        private void EnableDoubleBuffering(Control ctrl)
        {
            PropertyInfo pi = ctrl.GetType().GetProperty("DoubleBuffered", BindingFlags.Instance | BindingFlags.NonPublic);
            pi?.SetValue(ctrl, true, null);
        }
    }
}



==========================================
FILE: InputGroupManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\InputGroupManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [MANAGER] Quản lý khu vực nhập liệu (Góc trái màn hình).
    /// Nhiệm vụ: Xử lý quét mã, tự động thêm hậu tố (Suffix) và đóng gói gửi đi.
    /// </summary>
    public class InputGroupManager
    {
        // 1. Các tham chiếu UI
        private readonly MatrixManager _matrixManager; // Cầu nối để gửi dữ liệu
        private readonly DataGridView _dgvInput;
        private readonly Button _btnGui;

        private readonly TextBox _txtNguoiGui;
        private readonly TextBox _txtNguoiNhan;
        private readonly TextBox _txtCarrier;
        private readonly ComboBox _cboLine;

        // 2. Các Radio Button (Chọn loại mẫu)
        private readonly RadioButton _radKhac;
        private readonly RadioButton _radDen;
        private readonly RadioButton _radDo;
        private readonly RadioButton _radXanhLa;
        private readonly RadioButton _radXanhDuong;
        private readonly RadioButton _radNuocTieu;
        private readonly RadioButton _radPCD;

        public InputGroupManager(
            MatrixManager matrixManager,
            DataGridView dgvInput,
            Button btnGui,
            TextBox txtNguoiGui, TextBox txtNguoiNhan, TextBox txtCarrier, ComboBox cboLine,
            RadioButton rKhac, RadioButton rDen, RadioButton rDo,
            RadioButton rXla, RadioButton rXdu, RadioButton rNt, RadioButton rPcd)
        {
            _matrixManager = matrixManager;
            _dgvInput = dgvInput;
            _btnGui = btnGui;
            _txtNguoiGui = txtNguoiGui;
            _txtNguoiNhan = txtNguoiNhan;
            _txtCarrier = txtCarrier;
            _cboLine = cboLine;

            _radKhac = rKhac;
            _radDen = rDen;
            _radDo = rDo;
            _radXanhLa = rXla;
            _radXanhDuong = rXdu;
            _radNuocTieu = rNt;
            _radPCD = rPcd;

            Console.WriteLine("[INPUT-MGR] 🟢 Khởi tạo Manager quản lý nhập liệu.");
            SetupUI();
            RegisterEvents();
        }

        private void SetupUI()
        {
            _cboLine.Items.Clear();
            _cboLine.Items.AddRange(new string[] { "T1->T3", "T3->T1" });
            if (_cboLine.Items.Count > 0) _cboLine.SelectedIndex = 0;

            _dgvInput.Columns.Clear();
            _dgvInput.AutoGenerateColumns = false;
            _dgvInput.AllowUserToAddRows = true;
            _dgvInput.RowHeadersVisible = false;

            var colSTT = new DataGridViewTextBoxColumn();
            colSTT.HeaderText = "STT";
            colSTT.Width = 40;
            colSTT.ReadOnly = true;
            colSTT.DefaultCellStyle.BackColor = Color.LightGray;
            colSTT.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;
            _dgvInput.Columns.Add(colSTT);

            var colSID = new DataGridViewTextBoxColumn();
            colSID.HeaderText = "Mã Xét Nghiệm (SID)";
            colSID.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill;
            _dgvInput.Columns.Add(colSID);

            _radKhac.Checked = true; // Mặc định

            Console.WriteLine("[INPUT-MGR] 🛠️ Đã cấu hình UI xong.");
        }

        private void RegisterEvents()
        {
            _dgvInput.CellEndEdit += DgvInput_CellEndEdit;
            _dgvInput.RowsAdded += (s, e) => UpdateSTT();
            _dgvInput.RowsRemoved += (s, e) => UpdateSTT();
            _btnGui.Click += BtnGui_Click;
        }

        // ==========================================================
        // [QUAN TRỌNG] LOGIC HẬU TỐ (SUFFIX) ĐÃ CẬP NHẬT
        // ==========================================================
        private string GetCurrentSuffix()
        {
            if (_radDen.Checked) return " Đen";       // Có khoảng trắng phía trước
            if (_radDo.Checked) return " Đỏ";
            if (_radXanhLa.Checked) return " X.Lá";
            if (_radXanhDuong.Checked) return " X.Dương";
            if (_radNuocTieu.Checked) return " NT";
            if (_radPCD.Checked) return " PCĐ";

            return ""; // _radKhac hoặc chưa chọn gì
        }

        private void DgvInput_CellEndEdit(object sender, DataGridViewCellEventArgs e)
        {
            // Chỉ xử lý cột SID (Index 1)
            if (e.ColumnIndex == 1 && e.RowIndex >= 0)
            {
                var cell = _dgvInput.Rows[e.RowIndex].Cells[1];
                string rawValue = cell.Value?.ToString().Trim();

                if (!string.IsNullOrEmpty(rawValue))
                {
                    string suffix = GetCurrentSuffix();

                    // Logic: Chỉ thêm nếu có hậu tố VÀ chuỗi chưa có hậu tố đó
                    // Sử dụng StringComparison.OrdinalIgnoreCase để không phân biệt hoa thường
                    if (!string.IsNullOrEmpty(suffix) && !rawValue.EndsWith(suffix, StringComparison.OrdinalIgnoreCase))
                    {
                        string newValue = rawValue + suffix;
                        cell.Value = newValue;
                        Console.WriteLine($"[INPUT-SCAN] 🔫 Auto Suffix: '{rawValue}' -> '{newValue}'");
                    }
                }
            }
        }

        private void BtnGui_Click(object sender, EventArgs e)
        {
            Console.WriteLine("[INPUT-SEND] 🚀 Người dùng nhấn Gửi...");

            if (_dgvInput.Rows.Count <= 1 && string.IsNullOrWhiteSpace(_dgvInput.Rows[0].Cells[1].Value?.ToString()))
            {
                MessageBox.Show("Chưa có mã xét nghiệm nào được quét!", "Nhắc nhở", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            try
            {
                var newCol = new CotDuLieuModel();
                // Format ngày giờ đầy đủ
                newCol.GioGui = DateTime.Now.ToString("HH:mm dd/MM/yyyy");
                newCol.NguoiGui = _txtNguoiGui.Text.Trim();
                newCol.NguoiNhan = _txtNguoiNhan.Text.Trim();
                newCol.Carrier = _txtCarrier.Text.Trim();
                newCol.Line = _cboLine.SelectedItem?.ToString() ?? "";
                newCol.Status = 0; // Mặc định là chưa nhận
                newCol.Sids = new List<string>();

                foreach (DataGridViewRow row in _dgvInput.Rows)
                {
                    if (!row.IsNewRow)
                    {
                        string sid = row.Cells[1].Value?.ToString();
                        if (!string.IsNullOrWhiteSpace(sid))
                        {
                            newCol.Sids.Add(sid);
                        }
                    }
                }

                Console.WriteLine($"[INPUT-SEND] 📦 Đóng gói {newCol.Sids.Count} mẫu. Gửi sang Matrix...");

                if (_matrixManager != null)
                {
                    _matrixManager.AddNewColumn(newCol);
                    ClearForm();
                }
                else
                {
                    Console.WriteLine("[INPUT-ERR] ❌ MatrixManager bị Null!");
                    MessageBox.Show("Lỗi hệ thống: Không tìm thấy MatrixManager.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[INPUT-ERR] ❌ Lỗi khi gửi: {ex.Message}");
                MessageBox.Show("Có lỗi xảy ra: " + ex.Message);
            }
        }

        private void ClearForm()
        {
            _txtCarrier.Clear();
            _dgvInput.Rows.Clear();
            _radKhac.Checked = true; // Reset về Khác
            _txtCarrier.Focus();
            Console.WriteLine("[INPUT-MGR] ✨ Đã dọn dẹp Form.");
        }

        private void UpdateSTT()
        {
            for (int i = 0; i < _dgvInput.Rows.Count; i++)
            {
                if (!_dgvInput.Rows[i].IsNewRow)
                    _dgvInput.Rows[i].Cells[0].Value = (i + 1).ToString();
            }
        }
    }
}



==========================================
FILE: LabGridManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\LabGridManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [DERIVED CLASS] Grid chuyên dụng cho Xét nghiệm.
    /// Kế thừa toàn bộ tính năng của GridManager và thêm logic Tô màu trùng.
    /// </summary>
    public class LabGridManager : GridManager<MauXetNghiemModel>
    {
        // Logic riêng: Danh sách các SID bị trùng
        private HashSet<string> _duplicateKeys = new HashSet<string>();

        public LabGridManager(DataGridView dgv, int maxRows) : base(dgv, maxRows)
        {
        }

        // 1. GHI ĐÈ logic tính toán: Mỗi khi data đổi -> Tính lại danh sách trùng
        protected override void OnDataSnapshotChanged()
        {
            lock (_lock)
            {
                _duplicateKeys.Clear();
                var counts = new Dictionary<string, int>();

                foreach (var item in _dataSnapshot)
                {
                    // Logic đặc thù: Key chính là SID
                    string key = item.SID;
                    if (!string.IsNullOrEmpty(key))
                    {
                        if (counts.ContainsKey(key)) counts[key]++;
                        else counts[key] = 1;
                    }
                }

                foreach (var kvp in counts)
                {
                    if (kvp.Value > 1) _duplicateKeys.Add(kvp.Key);
                }
            }
        }

        // 2. GHI ĐÈ logic hiển thị: Nếu trùng -> Tô Vàng
        protected override void OnCustomCellFormatting(DataGridViewCellFormattingEventArgs e, MauXetNghiemModel item, int rowIndex)
        {
            string key = item.SID;
            if (!string.IsNullOrEmpty(key) && _duplicateKeys.Contains(key))
            {
                e.CellStyle.BackColor = Color.Yellow;
                e.CellStyle.ForeColor = Color.Red;
                e.CellStyle.Font = new Font(e.CellStyle.Font, FontStyle.Bold);
            }
        }
    }
}



==========================================
FILE: MatrixManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\MatrixManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Reflection;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    public class MatrixManager
    {
        private readonly DataGridView _dgv;
        private List<CotDuLieuModel> _dataColumns;
        private readonly object _lock = new object();
        // --- CẤU HÌNH ---
        private const int HEADER_ROWS = 5;
        private const int INITIAL_SID_ROWS = 50;
        private const int MAX_SID_ROWS = 1000;
        private const int MAX_KEEP_COLS = 200;
        private int _currentSidRows = INITIAL_SID_ROWS;
        private readonly string[] _rowLabels = new string[] {
            "Thời Gian Gửi", "Carrier", "Từ -> Đến", "Người Gửi", "Người Nhận"
        };
        private int _currentMaxId = 0;
        private bool _isBatchUpdating = false;
        private HashSet<int> _dirtyColumnIds = new HashSet<int>();

        public event Action<CotDuLieuModel> OnColumnChanged;
        public event Action<int> OnColumnDeleted;

        public MatrixManager(DataGridView dgv)
        {
            _dgv = dgv ?? throw new ArgumentNullException(nameof(dgv));
            _dataColumns = new List<CotDuLieuModel>();

            Console.WriteLine($"[MATRIX-INIT] 🟢 Khởi tạo MatrixManager. Limit: {MAX_KEEP_COLS} cols.");
            SetupGrid();
            SetupClipboard();
        }

        public List<SearchResultModel> FindSidWithLocation(string keyword)
        {
            var results = new List<SearchResultModel>();
            if (string.IsNullOrWhiteSpace(keyword)) return results;

            string upperKey = keyword.ToUpper();
            lock (_lock)
            {
                for (int colIndex = 0; colIndex < _dataColumns.Count; colIndex++)
                {
                    var colData = _dataColumns[colIndex];
                    for (int sidIndex = 0; sidIndex < colData.Sids.Count; sidIndex++)
                    {
                        string sid = colData.Sids[sidIndex];
                        if (!string.IsNullOrEmpty(sid) && sid.ToUpper().Contains(upperKey))
                        {
                            string receiverInfo = "";
                            if (colData.Status == 1 && !string.IsNullOrEmpty(colData.NguoiNhan))
                            {
                                receiverInfo = $" - Nhận: {colData.NguoiNhan}";
                            }

                            string displayText = $"[GN] {colData.Line} - {colData.GioGui} - {colData.Carrier} - Gửi: {colData.NguoiGui}{receiverInfo} - {sid}";

                            var resultItem = new SearchResultModel()
                            {
                                DisplayText = displayText,
                                TargetGrid = _dgv,
                                RowIndex = HEADER_ROWS + sidIndex,
                                ColIndex = colIndex + 1,
                                BackColor = Color.Honeydew // Màu xanh lá nhạt
                            };
                            results.Add(resultItem);
                        }
                    }
                }
            }
            return results;
        }

        private void SetupGrid()
        {
            _dgv.AutoGenerateColumns = false;
            _dgv.DataSource = null;
            _dgv.Columns.Clear();

            EnableDoubleBuffering(_dgv);
            _dgv.VirtualMode = true;
            _dgv.AllowUserToAddRows = false;
            _dgv.AllowUserToDeleteRows = false;
            _dgv.RowHeadersVisible = false;
            _dgv.ColumnHeadersVisible = false;
            _dgv.BackgroundColor = Color.WhiteSmoke;
            _dgv.DefaultCellStyle.BackColor = Color.White;
            _dgv.DefaultCellStyle.ForeColor = Color.Black;
            _dgv.EditMode = DataGridViewEditMode.EditOnKeystrokeOrF2;
            _dgv.SelectionMode = DataGridViewSelectionMode.CellSelect;

            _dgv.DefaultCellStyle.WrapMode = DataGridViewTriState.True;
            _dgv.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.DisplayedCells;

            _currentSidRows = INITIAL_SID_ROWS;
            _dgv.RowCount = HEADER_ROWS + _currentSidRows;

            var colLabel = new DataGridViewTextBoxColumn();
            colLabel.Name = "Col_Labels";
            colLabel.Width = 120;
            colLabel.ReadOnly = true;
            colLabel.DefaultCellStyle.BackColor = Color.LightGray;
            colLabel.DefaultCellStyle.Font = new Font("Arial", 9, FontStyle.Bold);
            colLabel.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleLeft;
            _dgv.Columns.Add(colLabel);
            if (_dgv.Columns.Count > 0) _dgv.Columns[0].Frozen = true;

            _dgv.CellValueNeeded += Dgv_CellValueNeeded;
            _dgv.CellValuePushed += Dgv_CellValuePushed;
            _dgv.CellFormatting += Dgv_CellFormatting;
            _dgv.CellClick += Dgv_CellClick;
            Console.WriteLine("[MATRIX-MGR] 🛠️ Grid Setup Complete.");
        }

        public void AddNewColumn(CotDuLieuModel data = null, bool isFromUser = true)
        {
            if (_dgv.InvokeRequired) { _dgv.Invoke(new Action(() => AddNewColumn(data, isFromUser))); return; }
            var newCol = data ?? new CotDuLieuModel();
            if (isFromUser) { _currentMaxId++; newCol.Id = _currentMaxId; }
            else { if (newCol.Id > _currentMaxId) _currentMaxId = newCol.Id; }

            lock (_lock) { _dataColumns.Add(newCol); }

            var dgvCol = new DataGridViewTextBoxColumn();
            dgvCol.Name = $"Col_ID_{newCol.Id}";
            dgvCol.Width = 130;
            dgvCol.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;
            dgvCol.DefaultCellStyle.WrapMode = DataGridViewTriState.True;
            _dgv.Columns.Add(dgvCol);

            _dgv.FirstDisplayedScrollingColumnIndex = _dgv.Columns.Count - 1;

            if (isFromUser) OnColumnChanged?.Invoke(newCol);
            CheckAndRemoveOldColumns();
        }

        private void CheckAndRemoveOldColumns()
        {
            while (_dataColumns.Count > MAX_KEEP_COLS)
            {
                var oldCol = _dataColumns[0];
                lock (_lock) { _dataColumns.RemoveAt(0); }
                if (_dgv.Columns.Count > 1) _dgv.Columns.RemoveAt(1);
                OnColumnDeleted?.Invoke(oldCol.Id);
                Console.WriteLine($"[MATRIX-CLEAN] 🧹 Removed Old Column ID: {oldCol.Id}");
            }
        }

        public void LoadData(List<CotDuLieuModel> newData)
        {
            if (_dgv.InvokeRequired) { _dgv.Invoke(new Action(() => LoadData(newData))); return; }
            Console.WriteLine($"[MATRIX-LOAD] 📥 Loading {newData?.Count ?? 0} columns...");
            _dataColumns.Clear(); _currentMaxId = 0;
            while (_dgv.Columns.Count > 1) _dgv.Columns.RemoveAt(1);
            if (newData != null)
            {
                var sortedData = newData.OrderBy(x => x.Id).ToList();
                foreach (var col in sortedData) AddNewColumn(col, isFromUser: false);
            }
            _dgv.Invalidate();
        }

        public void UpdateColumnById(int colId, CotDuLieuModel newData)
        {
            var existingCol = _dataColumns.FirstOrDefault(c => c.Id == colId);
            if (existingCol != null)
            {
                int index = _dataColumns.IndexOf(existingCol);
                lock (_lock) { _dataColumns[index] = newData; }
                if (_dgv.IsHandleCreated) _dgv.BeginInvoke((Action)(() => _dgv.Invalidate()));
            }
            else
            {
                if (colId > _currentMaxId) AddNewColumn(newData, isFromUser: false);
            }
        }

        public void DeleteColumnById(int colId)
        {
            if (_dgv.InvokeRequired) { _dgv.Invoke(new Action(() => DeleteColumnById(colId))); return; }
            var target = _dataColumns.FirstOrDefault(c => c.Id == colId);
            if (target != null)
            {
                int index = _dataColumns.IndexOf(target);
                lock (_lock) { _dataColumns.RemoveAt(index); }
                if (_dgv.Columns.Count > index + 1) _dgv.Columns.RemoveAt(index + 1);
                Console.WriteLine($"[MATRIX-DEL] ✂️ Deleted Column ID: {colId}");
            }
        }

        private void Dgv_CellValueNeeded(object sender, DataGridViewCellValueEventArgs e)
        {
            if (e.ColumnIndex == 0)
            {
                if (e.RowIndex < HEADER_ROWS) e.Value = _rowLabels[e.RowIndex];
                else e.Value = (e.RowIndex - HEADER_ROWS + 1).ToString();
                return;
            }
            int dataColIndex = e.ColumnIndex - 1;

            // [THAY ĐỔI] Thêm lock để bảo vệ khi đọc _dataColumns
            CotDuLieuModel colData = null;
            lock (_lock)
            {
                if (dataColIndex >= 0 && dataColIndex < _dataColumns.Count)
                {
                    colData = _dataColumns[dataColIndex];
                }
            }

            if (colData != null)
            {
                if (e.RowIndex == 0) e.Value = colData.GioGui;
                else if (e.RowIndex == 1) e.Value = colData.Carrier;
                else if (e.RowIndex == 2) e.Value = colData.Line;
                else if (e.RowIndex == 3) e.Value = colData.NguoiGui;
                else if (e.RowIndex == 4)
                {
                    if (colData.Status == 0) e.Value = "📦 BẤM NHẬN";
                    else
                    {
                        string timeInfo = string.IsNullOrEmpty(colData.GioNhan) ? "" : $"({colData.GioNhan})";
                        e.Value = $"{colData.NguoiNhan}\n{timeInfo}";
                    }
                }
                else
                {
                    int sidIndex = e.RowIndex - HEADER_ROWS;
                    if (sidIndex < colData.Sids.Count) e.Value = colData.Sids[sidIndex];
                    else e.Value = "";
                }
            }
        }

        private void Dgv_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            if (e.ColumnIndex == 0 && e.RowIndex < HEADER_ROWS)
            {
                e.CellStyle.BackColor = Color.AliceBlue;
                e.CellStyle.Font = new Font(_dgv.Font, FontStyle.Bold);
                return;
            }

            // [THAY ĐỔI] Thêm lock bảo vệ khi truy cập _dataColumns trong CellFormatting
            if (e.RowIndex == 4 && e.ColumnIndex > 0)
            {
                int dataIndex = e.ColumnIndex - 1;
                CotDuLieuModel colData = null;
                lock (_lock)
                {
                    if (dataIndex < _dataColumns.Count) colData = _dataColumns[dataIndex];
                }

                if (colData != null)
                {
                    if (colData.Status == 0)
                    {
                        e.CellStyle.BackColor = Color.OrangeRed;
                        e.CellStyle.ForeColor = Color.White;
                        e.CellStyle.Font = new Font(_dgv.Font, FontStyle.Bold);
                        e.CellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;
                    }
                    else
                    {
                        e.CellStyle.BackColor = Color.Honeydew;
                        e.CellStyle.ForeColor = Color.DarkGreen;
                        e.CellStyle.Font = new Font("Arial", 8, FontStyle.Regular);
                    }
                }
                return;
            }

            if (e.RowIndex >= HEADER_ROWS && e.ColumnIndex > 0)
            {
                string sidValue = e.Value?.ToString();
                if (!string.IsNullOrEmpty(sidValue))
                {
                    if (sidValue.EndsWith(" Đen", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.FromArgb(64, 64, 64);
                        e.CellStyle.ForeColor = Color.White;
                    }
                    else if (sidValue.EndsWith(" Đỏ", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.LightCoral;
                        e.CellStyle.ForeColor = Color.Black;
                    }
                    else if (sidValue.EndsWith(" X.Lá", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.LightGreen;
                        e.CellStyle.ForeColor = Color.Black;
                    }
                    else if (sidValue.EndsWith(" X.Dương", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.LightSkyBlue;
                        e.CellStyle.ForeColor = Color.Black;
                    }
                    else if (sidValue.EndsWith(" NT", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.LightYellow;
                        e.CellStyle.ForeColor = Color.Black;
                    }
                    else if (sidValue.EndsWith(" PCĐ", StringComparison.OrdinalIgnoreCase))
                    {
                        e.CellStyle.BackColor = Color.Plum;
                        e.CellStyle.ForeColor = Color.Black;
                    }
                }
            }
        }

        private void Dgv_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex == 4 && e.ColumnIndex > 0)
            {
                int dataIndex = e.ColumnIndex - 1;
                // [THAY ĐỔI] Thêm lock trước khi lấy dữ liệu để xử lý click
                CotDuLieuModel colData = null;
                lock (_lock)
                {
                    if (dataIndex >= 0 && dataIndex < _dataColumns.Count) colData = _dataColumns[dataIndex];
                }

                if (colData != null)
                {
                    if (colData.Status == 0)
                    {
                        var confirm = MessageBox.Show($"Xác nhận nhận gói hàng từ {colData.NguoiGui}?", "Xác nhận", MessageBoxButtons.YesNo);
                        if (confirm == DialogResult.Yes)
                        {
                            colData.Status = 1;
                            colData.GioNhan = DateTime.Now.ToString("HH:mm dd/MM");
                            OnColumnChanged?.Invoke(colData);
                            _dgv.InvalidateCell(e.ColumnIndex, e.RowIndex);
                            Console.WriteLine($"[MATRIX-CLICK] 🖱️ User confirmed receiving package {colData.Id}");
                        }
                    }
                }
            }
        }

        private void Dgv_CellValuePushed(object sender, DataGridViewCellValueEventArgs e)
        {
            CheckAndExpandRows(e.RowIndex);
            SetValueAt(e.RowIndex, e.ColumnIndex, e.Value?.ToString());
        }

        private void SetValueAt(int rowIndex, int colIndex, string value)
        {
            if (colIndex == 0) return;
            int dataColIndex = colIndex - 1;
            string newValue = value ?? "";

            // [THAY ĐỔI] Thêm lock bảo vệ khi GHI dữ liệu
            lock (_lock)
            {
                if (dataColIndex >= 0 && dataColIndex < _dataColumns.Count)
                {
                    var colData = _dataColumns[dataColIndex];
                    if (rowIndex == 0) colData.GioGui = newValue;
                    else if (rowIndex == 1) colData.Carrier = newValue;
                    else if (rowIndex == 2) colData.Line = newValue;
                    else if (rowIndex == 3) colData.NguoiGui = newValue;
                    else if (rowIndex == 4) colData.NguoiNhan = newValue;
                    else
                    {
                        int sidIndex = rowIndex - HEADER_ROWS;
                        while (colData.Sids.Count <= sidIndex) colData.Sids.Add("");
                        colData.Sids[sidIndex] = newValue;
                    }
                    if (_isBatchUpdating) _dirtyColumnIds.Add(colData.Id);
                    else OnColumnChanged?.Invoke(colData);
                }
            }
        }

        private void SetupClipboard()
        {
            _dgv.ClipboardCopyMode = DataGridViewClipboardCopyMode.EnableWithoutHeaderText;
            _dgv.KeyDown += (s, e) => {
                if (e.Control && e.KeyCode == Keys.V) { PasteFromClipboard(); e.Handled = true; }
                else if (e.KeyCode == Keys.Delete) { DeleteSelectedCells(); e.Handled = true; }
            };
        }

        private void PasteFromClipboard()
        {
            try
            {
                string s = Clipboard.GetText();
                if (string.IsNullOrEmpty(s)) return;
                string[] lines = s.Split(new[] { "\r\n", "\n" }, StringSplitOptions.None);

                Console.WriteLine($"[MATRIX-PASTE] 📋 Pasting {lines.Length} rows...");
                if (_dgv.CurrentCell == null) return;
                int startRow = _dgv.CurrentCell.RowIndex;
                int startCol = _dgv.CurrentCell.ColumnIndex;
                CheckAndExpandRows(startRow + lines.Length);

                _isBatchUpdating = true; _dirtyColumnIds.Clear();
                for (int i = 0; i < lines.Length; i++)
                {
                    int r = startRow + i;
                    if (r >= _dgv.RowCount) break;
                    string[] cells = lines[i].Split('\t');
                    for (int j = 0; j < cells.Length; j++)
                    {
                        int c = startCol + j;
                        if (c >= _dgv.ColumnCount) break;
                        SetValueAt(r, c, cells[j]);
                    }
                }

                _isBatchUpdating = false;
                foreach (int id in _dirtyColumnIds)
                {
                    var col = _dataColumns.FirstOrDefault(x => x.Id == id);
                    if (col != null) OnColumnChanged?.Invoke(col);
                }
                _dgv.Invalidate();
            }
            catch (Exception ex) { Console.WriteLine($"[PASTE-ERR] {ex.Message}"); }
        }

        private void DeleteSelectedCells()
        {
            if (_dgv.SelectedCells.Count == 0) return;
            Console.WriteLine($"[MATRIX-DEL] 🗑️ Deleting {_dgv.SelectedCells.Count} cells...");

            _isBatchUpdating = true; _dirtyColumnIds.Clear();
            foreach (DataGridViewCell cell in _dgv.SelectedCells) SetValueAt(cell.RowIndex, cell.ColumnIndex, "");
            _isBatchUpdating = false;
            foreach (int id in _dirtyColumnIds)
            {
                var col = _dataColumns.FirstOrDefault(x => x.Id == id);
                if (col != null) OnColumnChanged?.Invoke(col);
            }
            _dgv.Invalidate();
        }

        public List<string> GetExportData()
        {
            var lines = new List<string>();
            lock (_lock)
            {
                lines.Add("--- DỮ LIỆU GIAO NHẬN (LOGISTICS) ---");
                lines.Add("ID,Giờ Gửi,Carrier,Tuyến,Người Gửi,Người Nhận,Trạng Thái,Danh sách SID (Cách nhau bởi |)");
                foreach (var col in _dataColumns)
                {
                    string status = col.Status == 1 ? "Đã nhận" : "Chưa nhận";
                    string sids = string.Join(" | ", col.Sids.Where(s => !string.IsNullOrEmpty(s)));
                    string safeSender = EscapeCsv(col.NguoiGui);
                    string safeReceiver = EscapeCsv(col.NguoiNhan);

                    string line = $"{col.Id},{col.GioGui},{col.Carrier},{col.Line},{safeSender},{safeReceiver},{status},{sids}";
                    lines.Add(line);
                }
            }
            Console.WriteLine($"[MATRIX-EXPORT] 📤 Đã trích xuất {_dataColumns.Count} gói hàng.");
            return lines;
        }

        private string EscapeCsv(string input)
        {
            if (string.IsNullOrEmpty(input)) return "";
            if (input.Contains(",") || input.Contains("\"") || input.Contains("\n"))
            {
                input = input.Replace("\"", "\"\"");
                return $"\"{input}\"";
            }
            return input;
        }

        private void CheckAndExpandRows(int r) { if (r - HEADER_ROWS >= _currentSidRows - 5) { _currentSidRows = Math.Min(_currentSidRows + 20, MAX_SID_ROWS); _dgv.RowCount = HEADER_ROWS + _currentSidRows; } }
        private void EnableDoubleBuffering(Control ctrl) { PropertyInfo pi = ctrl.GetType().GetProperty("DoubleBuffered", BindingFlags.Instance | BindingFlags.NonPublic); pi?.SetValue(ctrl, true, null); }
    }
}



==========================================
FILE: SearchManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\SearchManager.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;
using UBCS2_A.Models;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [MANAGER] Quản lý giao diện Tìm kiếm (Global Search UI).
    /// - Hiển thị kết quả dạng danh sách.
    /// - Bắt sự kiện Click/Enter để báo cho Form1 thực hiện điều hướng.
    /// </summary>
    public class SearchManager
    {
        private readonly DataGridView _dgv;

        // Danh sách kết quả hiện tại (Lưu trong RAM để truy xuất khi click)
        private List<SearchResultModel> _currentResults = new List<SearchResultModel>();

        // Sự kiện bắn ra ngoài Form1 khi người dùng chọn 1 dòng
        public event Action<SearchResultModel> OnResultSelected;

        public SearchManager(DataGridView dgv)
        {
            _dgv = dgv;
            Console.WriteLine("[SEARCH-MGR] 🟢 Khởi tạo Search Manager (Smart Navigation).");
            SetupGrid();
        }

        /// <summary>
        /// Cấu hình DataGridView cho bảng tìm kiếm.
        /// </summary>
        private void SetupGrid()
        {
            Console.WriteLine("[SEARCH-MGR] 🛠️ Đang cấu hình Grid Search...");
            _dgv.AutoGenerateColumns = false;
            _dgv.Columns.Clear();
            _dgv.BackgroundColor = Color.White;
            _dgv.RowHeadersVisible = false;

            // [QUAN TRỌNG] Tắt tính năng user tự thêm dòng
            _dgv.AllowUserToAddRows = false;
            _dgv.AllowUserToDeleteRows = false;
            _dgv.AllowUserToResizeRows = false;

            // Chọn nguyên dòng nhưng ẩn màu xanh mặc định (xử lý ở CellFormatting)
            _dgv.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            _dgv.CellBorderStyle = DataGridViewCellBorderStyle.None;

            // Tự động giãn chiều cao dòng theo nội dung text
            _dgv.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.DisplayedCells;
            _dgv.ColumnHeadersVisible = false; // Ẩn tiêu đề cột cho gọn
            _dgv.ReadOnly = true; // Chỉ xem

            // --- TẠO CỘT KẾT QUẢ ---
            var colResult = new DataGridViewTextBoxColumn()
            {
                Name = "colResult",
                HeaderText = "Kết Quả",
                AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill // Giãn hết chiều ngang
            };

            // Format: Tự xuống dòng, Canh lề nhỏ (Compact), Font 9
            colResult.DefaultCellStyle.WrapMode = DataGridViewTriState.True;
            colResult.DefaultCellStyle.Padding = new Padding(5, 2, 5, 2);
            colResult.DefaultCellStyle.Font = new Font("Segoe UI", 9, FontStyle.Regular);

            _dgv.Columns.Add(colResult);

            // Đăng ký sự kiện
            _dgv.CellFormatting += Dgv_CellFormatting;
            _dgv.CellClick += Dgv_CellClick; // [NEW] Bắt sự kiện click chuột
            _dgv.KeyDown += Dgv_KeyDown;     // [NEW] Bắt sự kiện phím Enter

            Console.WriteLine("[SEARCH-MGR] ✅ Cấu hình xong UI.");
        }

        /// <summary>
        /// Xử lý tô màu nền dựa trên loại kết quả.
        /// </summary>
        private void Dgv_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < _currentResults.Count)
            {
                var item = _currentResults[e.RowIndex];
                e.CellStyle.BackColor = item.BackColor;

                // [TRICK] Set màu Selection giống màu nền để ẩn hiệu ứng "bôi xanh" khi click
                e.CellStyle.SelectionBackColor = item.BackColor;
                e.CellStyle.SelectionForeColor = Color.Black;
            }
        }

        /// <summary>
        /// Xử lý khi click chuột vào dòng kết quả -> Bắn sự kiện điều hướng.
        /// </summary>
        private void Dgv_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < _currentResults.Count)
            {
                var item = _currentResults[e.RowIndex];
                Console.WriteLine($"[SEARCH-UI] 🖱️ User clicked row {e.RowIndex}. Navigating to {item.TargetGrid?.Name}...");
                OnResultSelected?.Invoke(item);
            }
        }

        /// <summary>
        /// Xử lý khi bấm Enter trên dòng kết quả -> Bắn sự kiện điều hướng.
        /// </summary>
        private void Dgv_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter && _dgv.CurrentRow != null)
            {
                int index = _dgv.CurrentRow.Index;
                if (index >= 0 && index < _currentResults.Count)
                {
                    Console.WriteLine($"[SEARCH-UI] ⌨️ User pressed Enter on row {index}. Navigating...");
                    OnResultSelected?.Invoke(_currentResults[index]);
                    e.Handled = true;
                }
            }
        }

        /// <summary>
        /// Hiển thị danh sách kết quả lên Grid.
        /// </summary>
        public void ShowResults(List<SearchResultModel> results)
        {
            _currentResults = results;

            // Xóa cũ nạp mới
            _dgv.Rows.Clear();

            if (_currentResults.Count > 0)
            {
                foreach (var item in _currentResults)
                {
                    _dgv.Rows.Add(item.DisplayText);
                }

                // Bỏ chọn dòng đầu tiên để tránh xanh lè
                _dgv.ClearSelection();
            }

            Console.WriteLine($"[SEARCH-UI] 🎨 Đã hiển thị {_currentResults.Count} dòng kết quả.");

            // Cuộn lên đầu để xem kết quả quan trọng nhất
            if (_dgv.RowCount > 0)
                _dgv.FirstDisplayedScrollingRowIndex = 0;
        }
    }
}



==========================================
FILE: TaskInputDialog.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\TaskInputDialog.cs
==========================================
using System;
using System.ComponentModel;
using System.Drawing; // Thư viện để vẽ giao diện (Point, Size, Color...)
using System.Windows.Forms; // Thư viện Winform chuẩn

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [UI] Form Popup nhập liệu khi giao việc.
    /// Form này được tạo hoàn toàn bằng code (không cần Designer).
    /// </summary>
    public class TaskInputDialog : Form
    {
        // --- CÁC CONTROL CÔNG KHAI (Để bên ngoài lấy dữ liệu) ---
        // [FIX LỖI WFO1000] Thêm dòng này trước mỗi Property
        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        public ComboBox CboKhuVuc { get; private set; }

        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        public TextBox TxtNoiDung { get; private set; }

        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        public Button BtnOK { get; private set; }

        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        public Button BtnCancel { get; private set; }

        /// <summary>
        /// Khởi tạo Form với mã SID đã quét được.
        /// </summary>
        /// <param name="sid">Mã xét nghiệm vừa quét</param>
        public TaskInputDialog(string sid)
        {
            // 1. Cấu hình cơ bản cho Form
            this.Text = "Giao Việc Nhanh"; // Tiêu đề cửa sổ
            this.Size = new Size(450, 280); // Kích thước: Rộng 450, Cao 280
            this.StartPosition = FormStartPosition.CenterParent; // Hiện giữa form cha
            this.FormBorderStyle = FormBorderStyle.FixedDialog; // Không cho kéo giãn
            this.MaximizeBox = false; // Ẩn nút phóng to
            this.MinimizeBox = false; // Ẩn nút thu nhỏ
            this.BackColor = Color.WhiteSmoke; // Màu nền nhẹ

            Console.WriteLine($"[TASK-UI] 🖼️ Đang khởi tạo Popup cho SID: {sid}");

            // 2. Gọi hàm vẽ các chi tiết lên Form
            InitializeControls(sid);
        }

        /// <summary>
        /// Hàm tự động vẽ các nút, ô nhập liệu lên Form.
        /// </summary>
        private void InitializeControls(string sid)
        {
            // Các thông số căn chỉnh vị trí
            int padding = 20;   // Khoảng cách lề
            int currentY = 20;  // Vị trí dòng hiện tại (tăng dần xuống dưới)
            int labelW = 100;   // Chiều rộng nhãn
            int inputW = 280;   // Chiều rộng ô nhập

            // --- A. HIỂN THỊ SID (Header) ---
            var lblTitle = new Label()
            {
                Text = $"SID: {sid}",
                Font = new Font("Segoe UI", 14, FontStyle.Bold),
                ForeColor = Color.DarkBlue,
                AutoSize = true,
                Location = new Point(padding, currentY)
            };
            this.Controls.Add(lblTitle);

            currentY += 45; // Xuống dòng

            // --- B. CHỌN KHU VỰC (COMBOBOX) ---
            var lblArea = new Label()
            {
                Text = "Nơi nhận:",
                Font = new Font("Segoe UI", 10),
                Location = new Point(padding, currentY + 3), // +3 để căn giữa dòng với ComboBox
                Width = labelW
            };
            this.Controls.Add(lblArea);

            CboKhuVuc = new ComboBox()
            {
                Location = new Point(padding + labelW, currentY),
                Width = inputW,
                Font = new Font("Segoe UI", 10),
                DropDownStyle = ComboBoxStyle.DropDownList // Chỉ cho chọn, không cho gõ linh tinh
            };
            // Thêm danh sách các phòng ban (Khớp với hệ thống phân quyền của bạn)
            // Cập nhật danh sách khớp 100% với Form1/AuthManager
            CboKhuVuc.Items.AddRange(new string[] {
                "Huyết học T1",
                "Sinh hóa T1",
                "Miễn dịch T1",
                "Huyết học T3",
                "SH-MD T3",
                
                // Tách Hành Chánh ra làm 2 để khớp với người nhận
                "Hành Chánh T1",
                "Hành Chánh T3",

                "Khác"
            });
            if (CboKhuVuc.Items.Count > 0) CboKhuVuc.SelectedIndex = 0; // Mặc định chọn cái đầu
            this.Controls.Add(CboKhuVuc);

            currentY += 45; // Xuống dòng

            // --- C. NHẬP NỘI DUNG (TEXTBOX) ---
            var lblContent = new Label()
            {
                Text = "Nội dung:",
                Font = new Font("Segoe UI", 10),
                Location = new Point(padding, currentY + 3),
                Width = labelW
            };
            this.Controls.Add(lblContent);

            TxtNoiDung = new TextBox()
            {
                Location = new Point(padding + labelW, currentY),
                Width = inputW,
                Font = new Font("Segoe UI", 10)
            };
            this.Controls.Add(TxtNoiDung);

            currentY += 60; // Xuống dòng xa hơn chút để đặt nút

            // --- D. CÁC NÚT BẤM (BUTTONS) ---

            // Nút OK (Giao Việc)
            BtnOK = new Button()
            {
                Text = "Giao Việc",
                DialogResult = DialogResult.OK, // Quan trọng: Bấm nút này trả về OK
                Location = new Point(130, currentY),
                Width = 110,
                Height = 35,
                BackColor = Color.DodgerBlue,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold),
                Cursor = Cursors.Hand,
                FlatStyle = FlatStyle.Flat // Phẳng cho đẹp
            };
            BtnOK.FlatAppearance.BorderSize = 0;
            this.Controls.Add(BtnOK);

            // Nút Cancel (Hủy)
            BtnCancel = new Button()
            {
                Text = "Hủy Bỏ",
                DialogResult = DialogResult.Cancel, // Quan trọng: Bấm nút này trả về Cancel
                Location = new Point(250, currentY),
                Width = 90,
                Height = 35,
                BackColor = Color.LightGray,
                Font = new Font("Segoe UI", 9),
                Cursor = Cursors.Hand,
                FlatStyle = FlatStyle.Flat
            };
            BtnCancel.FlatAppearance.BorderSize = 0;
            this.Controls.Add(BtnCancel);

            // --- E. CẤU HÌNH PHÍM TẮT ---
            this.AcceptButton = BtnOK;     // Bấm Enter = Click OK
            this.CancelButton = BtnCancel; // Bấm ESC = Click Cancel

            // Sự kiện: Khi form hiện lên, tự động đặt con trỏ chuột vào ô Nội dung
            this.Load += (s, e) => TxtNoiDung.Focus();
        }
    }
}



==========================================
FILE: TaskManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\TaskManager.cs
==========================================
using System;
using System.Windows.Forms;
using UBCS2_A.Models;
using UBCS2_A.Services;

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [MANAGER] Quản lý logic giao diện Giao Task.
    /// Nhiệm vụ:
    /// 1. Lắng nghe ô Textbox quét mã (txtTaskSID).
    /// 2. Hiển thị Popup nhập liệu (TaskInputDialog).
    /// 3. Gọi Context để lưu Task.
    /// </summary>
    public class TaskManager
    {
        private readonly TextBox _txtScan;   // Ô để quét mã
        private readonly TaskContext _context; // Nơi xử lý dữ liệu

        public TaskManager(TextBox txtScan, TaskContext context)
        {
            _txtScan = txtScan;
            _context = context;

            Console.WriteLine("[TASK-MGR] 🟢 Khởi tạo TaskManager.");
            RegisterEvents();
        }

        private void RegisterEvents()
        {
            // Bắt sự kiện phím Enter trên ô quét mã
            _txtScan.KeyDown += TxtScan_KeyDown;
        }

        private void TxtScan_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                string sid = _txtScan.Text.Trim();

                if (!string.IsNullOrEmpty(sid))
                {
                    Console.WriteLine($"[TASK-SCAN] 🔫 Đã quét SID: '{sid}'. Đang mở Popup...");

                    // 1. Mở cửa sổ Popup
                    ShowTaskDialog(sid);

                    // 2. Clear ô quét và Focus lại để sẵn sàng cho mẫu tiếp theo
                    _txtScan.Clear();
                    _txtScan.Focus();
                }

                // Chặn tiếng "Beep" khó chịu của Windows khi nhấn Enter
                e.SuppressKeyPress = true;
                e.Handled = true;
            }
        }

        private void ShowTaskDialog(string sid)
        {
            // Tạo form popup và hiển thị
            using (var dialog = new TaskInputDialog(sid))
            {
                // ShowDialog: Hiện form và chặn không cho thao tác form chính đến khi đóng
                var result = dialog.ShowDialog();

                if (result == DialogResult.OK)
                {
                    // Người dùng bấm "Giao Việc"
                    string area = dialog.CboKhuVuc.SelectedItem?.ToString() ?? "Khác";
                    string content = dialog.TxtNoiDung.Text.Trim();

                    Console.WriteLine($"[TASK-ACTION] ✅ User xác nhận: Giao cho {area} - Nội dung: {content}");

                    // Tạo Model Task
                    var task = new TaskModel()
                    {
                        ThoiGian = DateTime.Now.ToString("HH:mm dd/MM"),
                        SID = sid,
                        KhuVucNhan = area,
                        NoiDung = content,
                        TrangThai = 0 // Mới
                    };

                    // Gọi Context để xử lý lưu trữ
                    _context.AddNewTask(task);
                }
                else
                {
                    // Người dùng bấm "Hủy" hoặc tắt form
                    Console.WriteLine("[TASK-ACTION] ❌ User hủy giao việc.");
                }
            }
        }
    }
}



==========================================
FILE: UIExtensions.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\UIExtensions.cs
==========================================
using System.Windows.Forms;

namespace UBCS2_A.Helpers
{
    public static class UIExtensions
    {
        /// <summary>
        /// Tự động tìm TabPage chứa Control này và kích hoạt nó (Focus).
        /// </summary>
        public static void FocusOnTab(this Control control)
        {
            if (control == null) return;

            Control current = control.Parent;
            while (current != null)
            {
                // Nếu tìm thấy TabPage và nó đang nằm trong một TabControl
                if (current is TabPage page && page.Parent is TabControl tabControl)
                {
                    tabControl.SelectedTab = page; // Kích hoạt Tab
                    break; // Xong việc, thoát vòng lặp
                }
                current = current.Parent; // Leo lên cấp cao hơn
            }

            // Sau khi bật Tab, focus vào chính control đó
            if (control.CanFocus) control.Focus();
        }
    }
}



==========================================
FILE: UpdateManager.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Helpers\UpdateManager.cs
==========================================
using System;
using System.Diagnostics;
using System.IO;
using System.Net.Http;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Services;
using UBCS2_A.Models;
using System.Drawing; // Thư viện để vẽ giao diện Popup (Form, ProgressBar...)

namespace UBCS2_A.Helpers
{
    /// <summary>
    /// [HELPER] Quản lý tính năng tự động cập nhật (Auto-Update).
    /// - [FIX] Sửa lỗi parse version (loại bỏ hậu tố +git_hash).
    /// - Cơ chế: Tải file .tmp -> Tạo file .bat -> Tắt App -> Bat xóa App cũ & đổi tên App mới -> Bật lại.
    /// </summary>
    public class UpdateManager
    {
        private readonly FirebaseService _firebaseService;

        // Lấy tên file EXE hiện tại đang chạy (VD: UBCS2-A.exe)
        private readonly string _currentExeName = Path.GetFileName(Application.ExecutablePath);

        public UpdateManager(FirebaseService firebaseService)
        {
            _firebaseService = firebaseService;
        }

        /// <summary>
        /// Hàm kiểm tra và thực hiện cập nhật (Gọi hàm này ở cuối Form1_Load).
        /// </summary>
        public async Task CheckForUpdateAsync()
        {
            Console.WriteLine("[UPDATER] 🔍 Đang kiểm tra phiên bản mới...");

            try
            {
                // 1. Lấy thông tin từ Firebase (Node: SystemInfo)
                var info = await _firebaseService.GetDataAsync<SystemInfoModel>("SystemInfo");

                if (info == null || string.IsNullOrEmpty(info.DownloadUrl))
                {
                    Console.WriteLine("[UPDATER] ⚠️ Không tìm thấy thông tin Update trên Server.");
                    return;
                }

                // 2. Lấy Version hiện tại của App
                // Trong .NET 8, chuỗi này thường có dạng: "1.0.36+ab123cde..." (Kèm mã Hash Git)
                string currentVersionStr = Application.ProductVersion;

                // [FIX QUAN TRỌNG] Cắt bỏ phần đuôi rác (+...) để tránh lỗi "Input string was not in a correct format"
                if (currentVersionStr.Contains("+"))
                {
                    currentVersionStr = currentVersionStr.Split('+')[0];
                }

                Console.WriteLine($"[UPDATER] So sánh: Máy ({currentVersionStr}) vs Server ({info.Version})");

                // 3. So sánh phiên bản
                Version currentVer = Version.Parse(currentVersionStr);
                Version newVer = Version.Parse(info.Version);

                if (newVer > currentVer)
                {
                    // CÓ BẢN MỚI -> Hỏi người dùng
                    DialogResult dr = MessageBox.Show(
                        $"Phát hiện phiên bản mới: {info.Version}\n\nBạn có muốn tải về và cập nhật ngay không?",
                        "Cập nhật phần mềm",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Information);

                    if (dr == DialogResult.Yes)
                    {
                        await PerformUpdateProcess(info.DownloadUrl);
                    }
                }
                else
                {
                    Console.WriteLine("[UPDATER] ✅ Phần mềm đang ở phiên bản mới nhất.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[UPDATER-ERR] ❌ Lỗi kiểm tra update: {ex.Message}");
            }
        }

        /// <summary>
        /// Quy trình tải file, tạo script .bat và tráo đổi file.
        /// </summary>
        private async Task PerformUpdateProcess(string url)
        {
            // A. Tạo giao diện Popup tiến trình (Code-First UI)
            Form progressForm = new Form()
            {
                Text = "Đang tải bản cập nhật...",
                Size = new Size(450, 150),
                StartPosition = FormStartPosition.CenterScreen,
                FormBorderStyle = FormBorderStyle.FixedDialog,
                ControlBox = false, // Không hiện nút tắt X để bắt buộc đợi
                TopMost = true
            };

            Label lblStatus = new Label()
            {
                Text = "Đang kết nối tới máy chủ...",
                Location = new Point(20, 20),
                AutoSize = true,
                Font = new Font("Segoe UI", 10)
            };

            ProgressBar progressBar = new ProgressBar()
            {
                Location = new Point(20, 50),
                Width = 390,
                Height = 30,
                Style = ProgressBarStyle.Continuous
            };

            progressForm.Controls.Add(lblStatus);
            progressForm.Controls.Add(progressBar);
            progressForm.Show();

            try
            {
                // B. Tải file về dạng .tmp (Tránh xung đột file đang chạy)
                string tempFilePath = Path.Combine(Application.StartupPath, "update_temp.exe");

                using (HttpClient client = new HttpClient())
                {
                    // Giả lập User-Agent để Github/Server không chặn request
                    client.DefaultRequestHeaders.Add("User-Agent", "UBCS2-Updater");
                    client.Timeout = TimeSpan.FromMinutes(5); // Tăng timeout cho mạng chậm

                    using (var response = await client.GetAsync(url, HttpCompletionOption.ResponseHeadersRead))
                    {
                        response.EnsureSuccessStatusCode();
                        long? totalBytes = response.Content.Headers.ContentLength;

                        using (var stream = await response.Content.ReadAsStreamAsync())
                        using (var fileStream = new FileStream(tempFilePath, FileMode.Create, FileAccess.Write, FileShare.None))
                        {
                            var buffer = new byte[8192]; // Đọc từng cục 8KB
                            long totalRead = 0;
                            int bytesRead;

                            while ((bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length)) > 0)
                            {
                                await fileStream.WriteAsync(buffer, 0, bytesRead);
                                totalRead += bytesRead;

                                if (totalBytes.HasValue)
                                {
                                    int progress = (int)((totalRead * 100) / totalBytes.Value);

                                    // Cập nhật giao diện (Invoke về luồng UI)
                                    progressForm.Invoke(new Action(() => {
                                        progressBar.Value = progress;
                                        double mbRead = Math.Round(totalRead / 1024.0 / 1024.0, 2);
                                        lblStatus.Text = $"Đang tải... {progress}% ({mbRead} MB)";
                                    }));
                                }
                            }
                        }
                    }
                }

                progressForm.Close(); // Tải xong thì tắt popup

                // C. Tạo file BAT để thực hiện tráo đổi (Magic happens here)
                // Kịch bản:
                // 1. Chờ 2 giây cho App chính tắt hẳn.
                // 2. Xóa file exe cũ.
                // 3. Đổi tên file update_temp.exe thành tên exe chính.
                // 4. Bật lại App mới.
                // 5. Tự xóa file bat.

                string batchScriptPath = Path.Combine(Application.StartupPath, "updater.bat");
                string script = $@"
@echo off
timeout /t 2 /nobreak > NUL
del ""{_currentExeName}""
move ""update_temp.exe"" ""{_currentExeName}""
start """" ""{_currentExeName}""
del ""%~f0""
";
                File.WriteAllText(batchScriptPath, script);

                // D. Chạy file BAT và Tự sát (Tắt App hiện tại)
                ProcessStartInfo psi = new ProcessStartInfo(batchScriptPath)
                {
                    CreateNoWindow = true,       // Chạy ngầm không hiện cửa sổ đen
                    UseShellExecute = false,
                    WindowStyle = ProcessWindowStyle.Hidden
                };

                Process.Start(psi);
                Application.Exit(); // [QUAN TRỌNG] Phải tắt App thì lệnh 'del' bên kia mới chạy được
            }
            catch (Exception ex)
            {
                progressForm.Close();
                MessageBox.Show($"Lỗi cập nhật: {ex.Message}\nVui lòng thử lại sau.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }
}



==========================================
FILE: ChatModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\ChatModel.cs
==========================================
using System;

namespace UBCS2_A.Models
{
    /// <summary>
    /// [MODEL] Cấu trúc một tin nhắn chat.
    /// </summary>
    public class ChatModel
    {
        // ID định danh để xử lý cuốn chiếu (Chat_100, Chat_101...)
        public int Id { get; set; }

        public string ThoiGian { get; set; } // Giờ gửi
        public string NguoiGui { get; set; } // Tên người gửi (VD: Huyết học T1)
        public string NoiNhan { get; set; }  // Nơi nhận (VD: Sinh hóa T1, hoặc "Toàn viện")
        public string NoiDung { get; set; }  // Nội dung tin nhắn

        // Thuộc tính phụ trợ để tạo Key Firebase
        public string FirebaseKey => $"Chat_{Id}";
    }
}



==========================================
FILE: CotDuLieuModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\CotDuLieuModel.cs
==========================================
using System.Collections.Generic;

namespace UBCS2_A.Models
{
    /// <summary>
    /// [MODEL] Cấu trúc dữ liệu của một cột giao nhận (Một gói hàng).
    /// </summary>
    public class CotDuLieuModel
    {
        // [QUAN TRỌNG] ID định danh duy nhất (Ví dụ: 100, 101, 102...)
        // Dùng để tạo Key trên Firebase: Col_100, Col_101... thay vì Col_0, Col_1
        public int Id { get; set; } = 0;

        // Trạng thái: 0 = Chưa nhận (Hiện nút bấm), 1 = Đã nhận (Hiện tên)
        public int Status { get; set; } = 0;

        public string GioGui { get; set; } = "";  // VD: "10:30 12/01"
        public string GioNhan { get; set; } = ""; // VD: "14:00 12/01" (Lưu khi bấm nhận)

        public string Carrier { get; set; } = "";
        public string Line { get; set; } = "";
        public string NguoiGui { get; set; } = "";
        public string NguoiNhan { get; set; } = "";

        // Danh sách các mã xét nghiệm (SID) trong gói
        public List<string> Sids { get; set; } = new List<string>();

        public CotDuLieuModel()
        {
            Sids = new List<string>();
        }
    }
}



==========================================
FILE: LogisticsModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\LogisticsModel.cs
==========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UBCS2_A.Models
{
    internal class LogisticsModel
    {
    }
}



==========================================
FILE: MauXetNghiemModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\MauXetNghiemModel.cs
==========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UBCS2_A.Models
{
    public class MauXetNghiemModel
    {
        public string FirebaseKey { get; set; } // ID ẩn
        public string STT { get; set; } = "";
        public string SID { get; set; } = "";
    }
}



==========================================
FILE: SearchResultModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\SearchResultModel.cs
==========================================
using System.Drawing;
using System.Windows.Forms;

namespace UBCS2_A.Models
{
    /// <summary>
    /// [MODEL] Kết quả tìm kiếm kèm địa chỉ điều hướng.
    /// Chứa thông tin để khi Click vào sẽ biết cần nhảy đến Grid nào, Dòng nào, Cột nào.
    /// </summary>
    public class SearchResultModel
    {
        // Nội dung hiển thị trên bảng Search (VD: "[LAB] Huyết học: 12345")
        public string DisplayText { get; set; }

        // --- ĐỊA CHỈ GỐC ---
        public DataGridView TargetGrid { get; set; } // Bảng chứa dữ liệu này
        public int RowIndex { get; set; }            // Dòng số mấy
        public int ColIndex { get; set; }            // Cột số mấy (thường là cột SID)

        // Màu nền để phân loại (Logistics vs Lab)
        public Color BackColor { get; set; }
    }
}



==========================================
FILE: SystemInfoModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\SystemInfoModel.cs
==========================================
using System;

namespace UBCS2_A.Models
{
    public class SystemInfoModel
    {
        public string Version { get; set; } = "1.0.0";
        public string DownloadUrl { get; set; } = "";
    }
}



==========================================
FILE: TaskModel.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Models\TaskModel.cs
==========================================
using System;

namespace UBCS2_A.Models
{
    /// <summary>
    /// [MODEL] Cấu trúc dữ liệu của một Task giao việc.
    /// </summary>
    public class TaskModel
    {
        // [QUAN TRỌNG] ID định danh duy nhất (Ví dụ: 100, 101...)
        // Dùng để tạo Key Firebase: Task_100, Task_101 (Thay vì dựa vào số dòng)
        public int Id { get; set; } = 0;

        public string ThoiGian { get; set; } = "";
        public string KhuVucNhan { get; set; } = "";
        public string SID { get; set; } = "";
        public string NoiDung { get; set; } = "";

        // Trạng thái: 0=Mới, 1=Đang làm, 2=Xong
        public int TrangThai { get; set; } = 0;

        // Key Firebase (Optional, dùng để tham chiếu nếu cần)
        public string FirebaseKey => $"Task_{Id}";
    }
}



==========================================
FILE: BackupService.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\BackupService.cs
==========================================
using System;
using System.Collections.Generic;
using System.IO;
using System.Text;
using System.Windows.Forms;
using UBCS2_A.Helpers;

namespace UBCS2_A.Services
{
    public class BackupService
    {
        private readonly LabDataContext _labContext;
        private readonly MatrixManager _matrixManager;
        private readonly string _saveFolder = "Thư mục lưu mẫu";
        private System.Windows.Forms.Timer _backupTimer;

        public BackupService(LabDataContext labContext, MatrixManager matrixManager)
        {
            _labContext = labContext;
            _matrixManager = matrixManager;

            if (!Directory.Exists(_saveFolder)) Directory.CreateDirectory(_saveFolder);

            // Timer backup tự động 5 phút
            _backupTimer = new System.Windows.Forms.Timer();
            _backupTimer.Interval = 5 * 60 * 1000;
            _backupTimer.Tick += (s, e) => PerformExport(isAuto: true);
        }

        public void StartAutoBackup() { _backupTimer.Start(); }
        public void StopAutoBackup() { _backupTimer.Stop(); }

        /// <summary>
        /// Hàm xuất dữ liệu.
        /// [UPDATE] Thêm tham số customFileName để hỗ trợ lệnh Xóa dữ liệu.
        /// </summary>
        public string PerformExport(bool isAuto, string customFileName = null)
        {
            try
            {
                // 1. Thu thập dữ liệu
                var allLines = new List<string>();
                allLines.Add($"BÁO CÁO DỮ LIỆU TOÀN HỆ THỐNG");
                allLines.Add($"Thời điểm: {DateTime.Now:HH:mm dd/MM/yyyy}");
                allLines.Add("");

                if (_matrixManager != null) allLines.AddRange(_matrixManager.GetExportData());
                if (_labContext != null) allLines.AddRange(_labContext.GetAllLabDataForExport());

                // 2. Xác định tên file
                string fileName;
                if (!string.IsNullOrEmpty(customFileName))
                {
                    // Nếu có tên tùy chỉnh (VD: Xóa 10-30 14-01-2025) thì dùng luôn
                    fileName = customFileName + ".csv";
                }
                else
                {
                    // Mặc định: Lưu mẫu dd-MM-yyyy
                    string dateString = DateTime.Now.ToString("dd-MM-yyyy");
                    fileName = $"Lưu mẫu {dateString}.csv";
                }

                string finalPath = Path.Combine(_saveFolder, fileName);

                // 3. Logic File Phụ (Tránh lỗi file đang mở)
                int counter = 1;
                string baseNameWithoutExt = Path.GetFileNameWithoutExtension(finalPath);

                while (IsFileLocked(finalPath))
                {
                    string tempName = $"{baseNameWithoutExt} ({counter}).csv";
                    finalPath = Path.Combine(_saveFolder, tempName);
                    counter++;
                    if (counter > 10) return null;
                }

                // 4. Ghi file
                File.WriteAllLines(finalPath, allLines, Encoding.UTF8);

                if (!isAuto) Console.WriteLine($"[BACKUP] ✅ Đã lưu file: {Path.GetFileName(finalPath)}");
                return finalPath;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[BACKUP-ERR] ❌ {ex.Message}");
                return null;
            }
        }

        private bool IsFileLocked(string filePath)
        {
            if (!File.Exists(filePath)) return false;
            try { using (FileStream stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.None)) { stream.Close(); } }
            catch (IOException) { return true; }
            return false;
        }
    }
}



==========================================
FILE: ChatContext.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\ChatContext.cs
==========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Helpers;
using UBCS2_A.Models;

namespace UBCS2_A.Services
{
    /// <summary>
    /// [CONTEXT] Quản lý dữ liệu Chat.
    /// - [UPDATE] ComboBox Nơi Gửi: Tách "Hành Chánh" thành "Hành Chánh T1" và "Hành Chánh T3".
    /// - [KEEP] Logic đồng bộ và xử lý dữ liệu.
    /// </summary>
    public class ChatContext : IDisposable
    {
        private readonly FirebaseService _firebaseService;
        private ChatManager _chatManager;

        // Dữ liệu RAM
        private List<ChatModel> _chatList = new List<ChatModel>();
        private readonly object _lock = new object();
        private int _currentMaxId = 0;

        private string _nodeName = "T_Chats";
        private const int MAX_MSG = 1000;

        private Control _invokeControl;

        public ChatContext(FirebaseService firebaseService)
        {
            _firebaseService = firebaseService;
            Console.WriteLine("[CHAT-CTX] 🔵 Khởi tạo ChatContext.");
        }

        #region 1. CẤU HÌNH UI & EVENTS

        public void RegisterControls(
            DataGridView dgvAll, DataGridView dgvPrivate,
            ComboBox cboTarget, TextBox txtContent, Button btnSend)
        {
            _invokeControl = dgvAll;
            // 1. Khởi tạo Manager quản lý 2 bảng
            _chatManager = new ChatManager(dgvAll, dgvPrivate);
            // 2. [CẬP NHẬT] Cấu hình ComboBox chọn nơi gửi
            cboTarget.Items.Clear();
            cboTarget.Items.AddRange(new string[] {
                "Toàn viện",
                "Huyết học T1",
                "Sinh hóa T1",
                "Miễn dịch T1",
                "Huyết học T3",
                "SH-MD T3", 
                
                // [ĐÃ TÁCH RIÊNG TẠI ĐÂY]
                "Hành Chánh T1",
                "Hành Chánh T3"
            });
            cboTarget.SelectedIndex = 0; // Mặc định chọn Toàn viện

            Console.WriteLine("[CHAT-CTX] 🛠️ Đã đăng ký UI Controls & Danh sách Nơi gửi.");
        }

        public void SetCurrentUserRole(string role)
        {
            if (_chatManager != null)
            {
                _chatManager.SetCurrentUserRole(role);
            }
        }

        #endregion

        #region 2. GỬI TIN & CUỐN CHIẾU

        public void SendMessageReal(string senderName, string target, string content)
        {
            lock (_lock)
            {
                _currentMaxId++;
                var msg = new ChatModel()
                {
                    Id = _currentMaxId,
                    ThoiGian = DateTime.Now.ToString("HH:mm"),
                    NguoiGui = senderName,
                    NoiNhan = target,
                    NoiDung = content
                };
                Console.WriteLine($"[CHAT-SEND] 📤 {senderName} -> {target}: {content}");

                _chatList.Add(msg);

                string key = $"Chat_{msg.Id}";
                _firebaseService.UpdateDataAsync($"{_nodeName}/{key}", msg);
                if (_chatList.Count > MAX_MSG)
                {
                    var oldMsg = _chatList[0];
                    _chatList.RemoveAt(0);
                    _firebaseService.DeleteDataAsync($"{_nodeName}/Chat_{oldMsg.Id}");
                }

                UpdateUI();
            }
        }

        private void UpdateUI()
        {
            if (_chatManager == null) return;

            // [THAY ĐỔI DUY NHẤT] Tạo bản sao (Snapshot) trong lock để tránh lỗi Collection Modified khi UI đang vẽ
            List<ChatModel> snapshot;
            lock (_lock)
            {
                snapshot = _chatList.ToList();
            }

            if (_invokeControl != null && _invokeControl.InvokeRequired)
            {
                _invokeControl.BeginInvoke(new Action(() => _chatManager.LoadData(snapshot)));
            }
            else
            {
                _chatManager.LoadData(snapshot);
            }
        }

        #endregion

        #region 3. ĐỒNG BỘ REALTIME (SYNC)

        public void StartSync()
        {
            _firebaseService.OnDataChanged += Firebase_OnDataChanged;
            _firebaseService.OnItemDeleted += Firebase_OnItemDeleted;
        }

        public async Task LoadInitialDataAsync()
        {
            try
            {
                var dict = await _firebaseService.GetDataAsync<Dictionary<string, ChatModel>>(_nodeName);
                if (dict != null)
                {
                    lock (_lock)
                    {
                        _chatList.Clear();
                        _currentMaxId = 0;

                        foreach (var kvp in dict)
                        {
                            if (kvp.Key.StartsWith("Chat_") && int.TryParse(kvp.Key.Substring(5), out int id))
                            {
                                var m = kvp.Value;
                                m.Id = id;
                                _chatList.Add(m);
                                if (id > _currentMaxId) _currentMaxId = id;
                            }
                        }

                        _chatList = _chatList.OrderBy(x => x.Id).ToList();
                        while (_chatList.Count > MAX_MSG) _chatList.RemoveAt(0);

                        UpdateUI();
                    }
                }
            }
            catch (Exception ex) { Console.WriteLine($"[CHAT-ERR] LoadInit: {ex.Message}"); }
        }

        private void Firebase_OnDataChanged(object sender, FirebaseDataEventArgs e)
        {
            if (e.RootNode != _nodeName) return;
            if (e.Key.StartsWith("Chat_") && int.TryParse(e.Key.Substring(5), out int id))
            {
                var msg = e.ToObject<ChatModel>();
                if (msg == null) return;
                msg.Id = id;

                lock (_lock)
                {
                    if (id > _currentMaxId) _currentMaxId = id;
                    var exist = _chatList.FirstOrDefault(x => x.Id == id);
                    if (exist == null)
                    {
                        _chatList.Add(msg);
                        _chatList = _chatList.OrderBy(x => x.Id).ToList();
                    }
                    else
                    {
                        _chatList[_chatList.IndexOf(exist)] = msg;
                    }

                    while (_chatList.Count > MAX_MSG) _chatList.RemoveAt(0);
                    UpdateUI();
                }
            }
        }

        private void Firebase_OnItemDeleted(object sender, FirebaseDeleteEventArgs e)
        {
            if (e.RootNode != _nodeName) return;
            if (e.TargetId.StartsWith("Chat_") && int.TryParse(e.TargetId.Substring(5), out int id))
            {
                lock (_lock)
                {
                    var target = _chatList.FirstOrDefault(x => x.Id == id);
                    if (target != null)
                    {
                        _chatList.Remove(target);
                        UpdateUI();
                    }
                }
            }
        }

        public void Dispose()
        {
            _firebaseService.OnDataChanged -= Firebase_OnDataChanged;
            _firebaseService.OnItemDeleted -= Firebase_OnItemDeleted;
        }

        #endregion
    }
}



==========================================
FILE: FirebaseService.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\FirebaseService.cs
==========================================
using System;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Net.Http;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace UBCS2_A.Services
{
    /// <summary>
    /// Service chịu trách nhiệm giao tiếp trực tiếp với Firebase REST API.
    /// Bao gồm các thao tác CRUD và lắng nghe luồng sự kiện Realtime (SSE).
    /// </summary>
    public class FirebaseService : IDisposable
    {
        // Các hằng số cấu hình kết nối
        private const string AUTH_PARAM = "auth";
        private const string STREAM_ACCEPT_HEADER = "text/event-stream";
        private const string MEDIA_TYPE_JSON = "application/json";

        private readonly string _baseUrl;
        private readonly string _secret;

        // HttpClient dùng chung (static) để tối ưu socket
        private static readonly HttpClient _httpClient = new HttpClient { Timeout = TimeSpan.FromMilliseconds(Timeout.Infinite) };

        private CancellationTokenSource _cancelTokenSource;
        private readonly object _serviceLock = new object();

        // Events để báo ra bên ngoài
        public event EventHandler<FirebaseDataEventArgs> OnDataChanged;   // Khi dữ liệu thay đổi
        public event EventHandler<FirebaseDeleteEventArgs> OnItemDeleted; // Khi dữ liệu bị xóa
        public event Action<string, Color> OnStatusChanged;               // Trạng thái kết nối

        public FirebaseService(string url, string secret)
        {
            _baseUrl = url.TrimEnd('/');
            _secret = secret;
            Console.WriteLine($"[FIREBASE] Service initialized with URL: {_baseUrl}");
        }

        /// <summary>
        /// Tải toàn bộ dữ liệu từ một Node (GET).
        /// Thường dùng khi khởi động app để nạp dữ liệu cũ.
        /// </summary>
        public async Task<T> GetDataAsync<T>(string path)
        {
            try
            {
                string url = BuildUrl(path);
                Console.WriteLine($"[FIREBASE-GET] Requesting: {url}");

                var response = await _httpClient.GetAsync(url);
                response.EnsureSuccessStatusCode();

                string json = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"[FIREBASE-GET] Response ({json.Length} chars): {json}");

                if (json == "null") return default(T);
                if (typeof(T) == typeof(string)) return (T)(object)json;

                return JsonConvert.DeserializeObject<T>(json);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[FIREBASE-ERR] GET Failed: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// Cập nhật hoặc ghi đè dữ liệu tại một đường dẫn cụ thể (PUT).
        /// Dùng khi người dùng sửa cell trên Grid.
        /// </summary>
        public async Task UpdateDataAsync<T>(string path, T data)
        {
            try
            {
                string url = BuildUrl(path);
                string json = JsonConvert.SerializeObject(data);
                Console.WriteLine($"[FIREBASE-PUT] Sending to {path}: {json}");

                var content = new StringContent(json, Encoding.UTF8, MEDIA_TYPE_JSON);
                var response = await _httpClient.PutAsync(url, content);
                response.EnsureSuccessStatusCode();

                Console.WriteLine($"[FIREBASE-PUT] Success!");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[FIREBASE-ERR] PUT Failed: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// Bắt đầu lắng nghe sự thay đổi dữ liệu theo thời gian thực (Server-Sent Events).
        /// Chạy trên một luồng (Thread) riêng biệt để không chặn UI.
        /// </summary>
        public void StartListening()
        {
            Stop(); // Dừng luồng cũ nếu có
            _cancelTokenSource = new CancellationTokenSource();
            var token = _cancelTokenSource.Token;

            Console.WriteLine("[FIREBASE-STREAM] Starting background listener...");
            Task.Run(async () => await ListenToStreamAsync(token), token);
        }

        /// <summary>
        /// Logic cốt lõi của việc lắng nghe Realtime.
        /// Duy trì kết nối HTTP dài hạn và đọc từng dòng sự kiện gửi về.
        /// </summary>
        private async Task ListenToStreamAsync(CancellationToken token)
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    OnStatusChanged?.Invoke("🟡 Connecting...", Color.Orange);
                    var requestUrl = $"{_baseUrl}/.json?{AUTH_PARAM}={_secret}";
                    Console.WriteLine($"[FIREBASE-STREAM] Connecting to: {requestUrl}");

                    var request = new HttpRequestMessage(HttpMethod.Get, requestUrl);
                    request.Headers.Add("Accept", STREAM_ACCEPT_HEADER);

                    using (var response = await _httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, token))
                    {
                        response.EnsureSuccessStatusCode();
                        using (var stream = await response.Content.ReadAsStreamAsync())
                        using (var reader = new StreamReader(stream))
                        {
                            OnStatusChanged?.Invoke("🟢 Live Connected", Color.Green);
                            Console.WriteLine("[FIREBASE-STREAM] Connected! Waiting for data...");

                            while (!reader.EndOfStream && !token.IsCancellationRequested)
                            {
                                string line = await reader.ReadLineAsync();
                                // Debug dữ liệu thô nhận được
                                if (!string.IsNullOrWhiteSpace(line))
                                    Console.WriteLine($"[FIREBASE-STREAM-RAW] {line}");

                                ProcessStreamLine(line);
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    if (!token.IsCancellationRequested)
                    {
                        Console.WriteLine($"[FIREBASE-STREAM-ERR] {ex.Message}. Retrying in 3s...");
                        OnStatusChanged?.Invoke("🔴 Disconnected", Color.Red);
                        await Task.Delay(3000, token);
                    }
                }
            }
        }

        /// <summary>
        /// Xử lý một dòng dữ liệu thô từ stream (dạng "data: {...}")
        /// và chuyển nó thành JSON Object để xử lý logic.
        /// </summary>
        private void ProcessStreamLine(string line)
        {
            if (string.IsNullOrWhiteSpace(line) || !line.StartsWith("data: ")) return;
            string json = line.Substring(6).Trim();
            if (json == "null") return; // Gói tin keep-alive

            try
            {
                var packet = JObject.Parse(json);
                string path = packet["path"]?.ToString() ?? "";
                JToken data = packet["data"];

                lock (_serviceLock) HandleDataLogic(path, data);
            }
            catch (Exception ex) { Console.WriteLine($"[PARSE ERROR] {ex.Message}"); }
        }

        /// <summary>
        /// Phân tích dữ liệu JSON để quyết định đó là sự kiện Sửa (Put) hay Xóa (Delete),
        /// sau đó bắn Event tương ứng ra cho SyncCoordinator xử lý.
        /// </summary>
        private void HandleDataLogic(string path, JToken data)
        {
            var segments = path.Split(new[] { '/' }, StringSplitOptions.RemoveEmptyEntries);

            // CASE 1: XÓA (Delete) - Data trả về là null
            if (data == null || data.Type == JTokenType.Null)
            {
                Console.WriteLine($"[FIREBASE-LOGIC] DELETE Detected on {path}");
                if (segments.Length >= 2)
                {
                    OnItemDeleted?.Invoke(this, new FirebaseDeleteEventArgs { RootNode = segments[0], TargetId = segments[1], FullPath = path });
                }
                else if (segments.Length == 1) // Xóa cả bảng
                {
                    OnItemDeleted?.Invoke(this, new FirebaseDeleteEventArgs { RootNode = segments[0], TargetId = "ALL", FullPath = path });
                }
                return;
            }

            // CASE 2: CẬP NHẬT (Update/Put)
            Console.WriteLine($"[FIREBASE-LOGIC] UPDATE Detected on {path}");
            string rootNode = segments.Length > 0 ? segments[0] : "Root";
            string key = segments.Length > 1 ? segments[1] : (data is JObject ? "Batch" : "Unknown");

            OnDataChanged?.Invoke(this, new FirebaseDataEventArgs
            {
                Path = path,
                RootNode = rootNode,
                Key = key,
                Data = data
            });
        }

        // --- Helper Methods ---
        private string BuildUrl(string path) => $"{_baseUrl}/{path.Trim('/')}.json?{AUTH_PARAM}={_secret}";

        public void Stop()
        {
            _cancelTokenSource?.Cancel();
            OnStatusChanged?.Invoke("⚪ Stopped", Color.Gray);
        }

        public void Dispose()
        {
            Stop();
            _cancelTokenSource?.Dispose();
        }

        // Các hàm Add/Patch/Delete giữ nguyên khung sườn (ít dùng trong dự án này nhưng cần cho đủ bộ)
        /// <summary>
        /// Thêm mới dữ liệu (PUSH). Firebase sẽ tự sinh Key ngẫu nhiên.
        /// </summary>
        public async Task<string> AddDataAsync<T>(string path, T data)
        {
            try
            {
                string url = BuildUrl(path);
                string json = JsonConvert.SerializeObject(data);
                Console.WriteLine($"[FIREBASE-POST] Adding to {path}: {json}"); // LOG DEBUG

                var content = new StringContent(json, Encoding.UTF8, MEDIA_TYPE_JSON);
                // POST: Gửi yêu cầu thêm mới
                var response = await _httpClient.PostAsync(url, content);
                response.EnsureSuccessStatusCode();

                // Firebase trả về JSON dạng: { "name": "-KeyTuSinhRa123" }
                string responseBody = await response.Content.ReadAsStringAsync();
                var result = JObject.Parse(responseBody);
                string newKey = result["name"]?.ToString();

                Console.WriteLine($"[FIREBASE-POST] Success! New Key: {newKey}"); // LOG DEBUG
                return newKey;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[FIREBASE-ERR] POST Failed: {ex.Message}"); // LOG DEBUG
                throw;
            }
        }
        /// <summary>
        /// Cập nhật một phần dữ liệu (PATCH). Chỉ sửa các trường được gửi lên, giữ nguyên các trường khác.
        /// </summary>
        public async Task PatchDataAsync(string path, object data)
        {
            try
            {
                string url = BuildUrl(path);
                string json = JsonConvert.SerializeObject(data);
                Console.WriteLine($"[FIREBASE-PATCH] Patching {path}: {json}"); // LOG DEBUG

                // HttpClient mặc định đời cũ không có PatchAsync, nên dùng SendAsync
                var request = new HttpRequestMessage(new HttpMethod("PATCH"), url)
                {
                    Content = new StringContent(json, Encoding.UTF8, MEDIA_TYPE_JSON)
                };

                var response = await _httpClient.SendAsync(request);
                response.EnsureSuccessStatusCode();

                Console.WriteLine($"[FIREBASE-PATCH] Success!"); // LOG DEBUG
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[FIREBASE-ERR] PATCH Failed: {ex.Message}"); // LOG DEBUG
                throw;
            }
        }
        /// <summary>
        /// Xóa dữ liệu tại đường dẫn (DELETE)
        /// </summary>
        public async Task DeleteDataAsync(string path)
        {
            try
            {
                string url = BuildUrl(path);
                Console.WriteLine($"[FIREBASE-DELETE] Requesting Delete: {url}"); // LOG DEBUG

                var response = await _httpClient.DeleteAsync(url);
                response.EnsureSuccessStatusCode();

                Console.WriteLine($"[FIREBASE-DELETE] Success! Node {path} has been removed."); // LOG DEBUG
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[FIREBASE-ERR] DELETE Failed: {ex.Message}"); // LOG DEBUG
                throw;
            }
        }
    }

    // Các class chứa dữ liệu sự kiện
    public class FirebaseDataEventArgs : EventArgs
    {
        public string Path { get; set; }
        public string RootNode { get; set; }
        public string Key { get; set; }
        public JToken Data { get; set; }
        public T ToObject<T>() => Data.ToObject<T>();
    }

    public class FirebaseDeleteEventArgs : EventArgs
    {
        public string RootNode { get; set; }
        public string TargetId { get; set; }
        public string FullPath { get; set; }
    }
}



==========================================
FILE: LabDataContext.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\LabDataContext.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Helpers;
using UBCS2_A.Models;

namespace UBCS2_A.Services
{
    public class LabDataContext : IDisposable
    {
        private readonly FirebaseService _firebaseService;

        // Quản lý các bộ đồng bộ cho Grid thường (Row-based)
        private readonly List<SyncCoordinator<MauXetNghiemModel>> _rowCoordinators = new List<SyncCoordinator<MauXetNghiemModel>>();

        // Dictionary lưu trữ tham chiếu để phục vụ tính năng Tìm kiếm & Export & Auth
        // Lưu ý: Ta lưu dưới dạng GridManager (lớp cha) để tổng quát, nhưng thực tế sẽ chứa LabGridManager
        private readonly Dictionary<string, (GridManager<MauXetNghiemModel> Manager, DataGridView Grid)> _registeredTables
            = new Dictionary<string, (GridManager<MauXetNghiemModel>, DataGridView)>();

        public LabDataContext(FirebaseService firebaseService)
        {
            _firebaseService = firebaseService;
            Console.WriteLine("[LAB-CTX] 🟢 Khởi tạo LabDataContext (Chuyên trị 9 bảng xét nghiệm).");
        }

        public void RegisterTable(DataGridView dgv, string nodeName, int maxRows = 2000)
        {
            Console.WriteLine($"[LAB-CTX] 📝 Đang đăng ký bảng xét nghiệm: {nodeName}");

            // 1. Cấu hình Grid (Giao diện)
            dgv.VirtualMode = true;
            dgv.AllowUserToAddRows = false;
            dgv.AllowUserToDeleteRows = false;
            dgv.RowHeadersVisible = false;
            dgv.ColumnHeadersHeight = 30;

            // =================================================================
            // [THAY ĐỔI] SỬ DỤNG LABGRIDMANAGER (LỚP CON)
            // =================================================================
            // Class này đã tích hợp sẵn logic Tô màu trùng & Trùng SID
            var manager = new LabGridManager(dgv, maxRows);
            // =================================================================

            // 2. Mapping hiển thị cột
            // Cột 0: STT (Tự tính dựa trên Index)
            // Cột 1: SID (Lấy từ Model)
            manager.OnGetValue = (rowIndex, model, colIndex) =>
            {
                if (colIndex == 0) return (rowIndex + 1).ToString();
                if (colIndex == 1) return model.SID;
                return "";
            };

            // 3. Mapping sửa dữ liệu (Chỉ cho sửa cột SID)
            manager.OnSetValue = (model, colIndex, value) =>
            {
                string val = value?.ToString() ?? "";
                if (colIndex == 1) model.SID = val.Trim();
            };

            // Lưu tham chiếu để dùng cho Search/Export/Auth sau này
            _registeredTables[nodeName] = (manager, dgv);

            // 4. Khởi tạo bộ đồng bộ Realtime (SyncCoordinator)
            var coord = new SyncCoordinator<MauXetNghiemModel>(
                manager,
                _firebaseService,
                nodeName,
                (row, m) => $"Row_{row}",
                (key) => int.TryParse(key.Replace("Row_", ""), out int r) ? r : -1,
                (m) => string.IsNullOrEmpty(m.SID)
            );

            _rowCoordinators.Add(coord);
        }

        /// <summary>
        /// Tìm kiếm SID trong tất cả 9 bảng, trả về vị trí chính xác để điều hướng.
        /// </summary>
        public List<SearchResultModel> GetSearchResultsWithLocation(string keyword)
        {
            var results = new List<SearchResultModel>();
            if (string.IsNullOrWhiteSpace(keyword)) return results;

            string upperKey = keyword.ToUpper();

            foreach (var kvp in _registeredTables)
            {
                var manager = kvp.Value.Manager;
                var data = manager.GetAllData(); // Lấy dữ liệu Snapshot an toàn từ Manager

                for (int i = 0; i < data.Count; i++)
                {
                    if (!string.IsNullOrEmpty(data[i].SID) && data[i].SID.ToUpper().Contains(upperKey))
                    {
                        results.Add(new SearchResultModel()
                        {
                            DisplayText = $"[LAB] {kvp.Key} - STT: {i + 1} - SID: {data[i].SID}",
                            TargetGrid = kvp.Value.Grid,
                            RowIndex = i,
                            ColIndex = 1,
                            BackColor = Color.LightYellow
                        });
                    }
                }
            }
            return results;
        }

        // =========================================================================
        // [ĐÃ SỬA TÊN HÀM] GetAllLabDataForExport (Khớp với BackupService)
        // =========================================================================
        public List<string> GetAllLabDataForExport()
        {
            var lines = new List<string>();
            lines.Add("--- DỮ LIỆU XÉT NGHIỆM (LAB) ---");
            lines.Add("Bảng,STT,SID");

            foreach (var kvp in _registeredTables)
            {
                string tableName = kvp.Key;
                var manager = kvp.Value.Manager;
                var data = manager.GetAllData();

                for (int i = 0; i < data.Count; i++)
                {
                    var r = data[i];
                    if (!string.IsNullOrEmpty(r.SID))
                    {
                        lines.Add($"{tableName},{i + 1},{r.SID}");
                    }
                }
            }
            Console.WriteLine($"[LAB-CTX] 📤 Đã trích xuất dữ liệu từ {_registeredTables.Count} bảng Lab.");
            return lines;
        }

        // =========================================================================
        // [MỚI] LOGIC PHÂN QUYỀN (Authorization) - Thay thế AuthorizationManager
        // =========================================================================

        public void SetUserRole(string roleName)
        {
            Console.WriteLine($"[LAB-CTX] 🔐 Đang áp dụng quyền: {roleName}");

            foreach (var kvp in _registeredTables)
            {
                string nodeName = kvp.Key;   // Tên bảng (VD: T1_HuyetHoc_CongThucMau)
                DataGridView dgv = kvp.Value.Grid;

                bool canEdit = CheckPermission(roleName, nodeName);
                ApplyGridState(dgv, canEdit);
            }
        }

        private bool CheckPermission(string role, string tableName)
        {
            if (role == "Admin" || role == "Hành Chánh T1" || role == "Hành Chánh T3") return true;
            if (role == "Khách") return false;

            // Logic so sánh tên (Mapping)
            // Tầng 1
            if (role == "Huyết học T1" && tableName.Contains("T1_HuyetHoc")) return true;
            if (role == "Sinh hóa T1" && tableName.Contains("T1_SinhHoa")) return true;
            if (role == "Miễn dịch T1" && tableName.Contains("T1_MienDich")) return true;

            // Tầng 3
            if (role == "Huyết học T3" && tableName.Contains("T3_HuyetHoc")) return true;

            // SH-MD T3 thường gộp chung Sinh hóa và Miễn dịch
            if (role == "SH-MD T3" && (tableName.Contains("T3_SinhHoa") || tableName.Contains("T3_MienDich"))) return true;

            return false;
        }

        private void ApplyGridState(DataGridView dgv, bool canEdit)
        {
            if (dgv.Columns.Count < 2) return;

            if (canEdit)
            {
                // CHẾ ĐỘ SỬA
                dgv.ReadOnly = false;
                dgv.Columns[1].ReadOnly = false; // Cột SID cho sửa
                dgv.Columns[1].DefaultCellStyle.BackColor = Color.White;
                dgv.Columns[1].DefaultCellStyle.ForeColor = Color.Black;
            }
            else
            {
                // CHẾ ĐỘ CHỈ XEM
                dgv.ReadOnly = true;
                dgv.Columns[1].DefaultCellStyle.BackColor = Color.LightGray;
                dgv.Columns[1].DefaultCellStyle.ForeColor = Color.DimGray;
            }
        }

        public async Task StartAllAsync()
        {
            Console.WriteLine("[LAB-CTX] 🚀 Bắt đầu quy trình khởi động cho các bảng Xét nghiệm...");

            _firebaseService.StartListening();

            foreach (var coord in _rowCoordinators)
            {
                coord.StartSync();
            }

            Console.WriteLine("[LAB-CTX] 📥 Đang tải dữ liệu Snapshot cho 9 bảng xét nghiệm...");
            var allLoadTasks = new List<Task>();

            foreach (var coord in _rowCoordinators)
            {
                allLoadTasks.Add(coord.LoadInitialData());
            }

            await Task.WhenAll(allLoadTasks);
            Console.WriteLine("[LAB-CTX] ✅ Hoàn tất tải dữ liệu 9 bảng Xét nghiệm.");
        }

        public void Dispose()
        {
            Console.WriteLine("[LAB-CTX] 🗑️ Đang hủy (Dispose) LabDataContext...");
            _firebaseService?.Dispose();
            foreach (var coord in _rowCoordinators) coord.Dispose();
            _rowCoordinators.Clear();
        }
    }
}



==========================================
FILE: LogisticsContext.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\LogisticsContext.cs
==========================================
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using UBCS2_A.Helpers;
using UBCS2_A.Models;

namespace UBCS2_A.Services
{
    /// <summary>
    /// [NEW CLASS] Context chuyên biệt quản lý dữ liệu Logistics (Giao nhận).
    /// Mục đích: Tách biệt hoàn toàn logic Matrix ra khỏi các bảng Xét nghiệm thường.
    /// </summary>
    public class LogisticsContext : IDisposable
    {
        // Service kết nối Firebase (Dùng chung instance với LabDataContext)
        private readonly FirebaseService _firebaseService;

        // Danh sách quản lý các bộ đồng bộ Matrix (Hiện tại chỉ có 1 bảng Giao Nhận)
        private readonly List<MatrixSyncCoordinator> _matrixCoordinators = new List<MatrixSyncCoordinator>();

        public LogisticsContext(FirebaseService firebaseService)
        {
            _firebaseService = firebaseService;
            Console.WriteLine("[LOGISTICS-CTX] 🟢 Khởi tạo Context Logistics (Sẵn sàng quản lý Matrix).");
        }

        /// <summary>
        /// Đăng ký một bảng Matrix vào hệ thống quản lý của Context này.
        /// </summary>
        /// <param name="matrixMgr">Quản lý giao diện Matrix (Grid)</param>
        /// <param name="nodeName">Tên Node trên Firebase</param>
        public void RegisterMatrixTable(MatrixManager matrixMgr, string nodeName)
        {
            Console.WriteLine($"[LOGISTICS-CTX] 📝 Đang đăng ký bảng Matrix: {nodeName}...");

            // Tạo bộ điều phối đồng bộ (Sync Coordinator) riêng cho Matrix
            var coordinator = new MatrixSyncCoordinator(matrixMgr, _firebaseService, nodeName);

            // Lưu vào danh sách để quản lý (Start/Dispose sau này)
            _matrixCoordinators.Add(coordinator);

            Console.WriteLine($"[LOGISTICS-CTX] ✅ Đăng ký thành công Matrix: {nodeName}");
        }

        /// <summary>
        /// Bước 1: Kích hoạt lắng nghe sự kiện (Sync) cho các Matrix.
        /// Cần gọi hàm này TRƯỚC khi Firebase bắt đầu Stream để không bỏ lỡ dữ liệu.
        /// </summary>
        public void PrepareSync()
        {
            Console.WriteLine("[LOGISTICS-CTX] 👂 Bắt đầu kích hoạt lắng nghe sự kiện cho các bảng Matrix...");
            foreach (var coord in _matrixCoordinators)
            {
                coord.StartSync();
            }
        }

        /// <summary>
        /// Bước 2: Tải dữ liệu ban đầu cho Matrix (chạy Async).
        /// Hàm này trả về Task để Form1 có thể dùng Task.WhenAll (chạy song song).
        /// </summary>
        public async Task LoadInitialDataAsync()
        {
            Console.WriteLine("[LOGISTICS-CTX] 📥 Bắt đầu tải dữ liệu khởi tạo (Snapshot) cho Matrix...");
            var tasks = new List<Task>();

            // Gom tất cả tác vụ tải của các bảng Matrix vào list
            foreach (var coord in _matrixCoordinators)
            {
                tasks.Add(coord.LoadInitialData());
            }

            // Chờ tất cả tải xong
            await Task.WhenAll(tasks);
            Console.WriteLine("[LOGISTICS-CTX] ✅ Hoàn tất tải dữ liệu cho toàn bộ Matrix.");
        }

        /// <summary>
        /// Dọn dẹp tài nguyên khi đóng Form.
        /// </summary>
        public void Dispose()
        {
            Console.WriteLine("[LOGISTICS-CTX] 🗑️ Đang hủy (Dispose) LogisticsContext...");
            foreach (var coord in _matrixCoordinators)
            {
                coord.Dispose();
            }
            Console.WriteLine("[LOGISTICS-CTX] 🏁 Đã hủy xong.");
        }

    }
}



==========================================
FILE: MatrixSyncCoordinator.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\MatrixSyncCoordinator.cs
==========================================
using System;
using System.Collections.Generic;
using System.Linq; // Cần dùng LINQ
using System.Threading.Tasks;
using UBCS2_A.Helpers;
using UBCS2_A.Models;

namespace UBCS2_A.Services
{
    /// <summary>
    /// [COORDINATOR] Cầu nối giữa MatrixManager và FirebaseService.
    /// - Chuyển đổi Model <-> Firebase JSON.
    /// - Xử lý Push (Gửi) và Pull (Nhận).
    /// </summary>
    public class MatrixSyncCoordinator : IDisposable
    {
        private readonly MatrixManager _matrix;
        private readonly FirebaseService _firebase;
        private readonly string _nodeName; // Tên node trên Firebase (VD: T_Logistics_Matrix)

        public MatrixSyncCoordinator(MatrixManager matrix, FirebaseService firebase, string nodeName)
        {
            _matrix = matrix;
            _firebase = firebase;
            _nodeName = nodeName;
        }

        public void StartSync()
        {
            // 1. Lắng nghe từ App (MatrixManager)
            _matrix.OnColumnChanged += Matrix_OnColumnChanged; // Khi thêm/sửa
            _matrix.OnColumnDeleted += Matrix_OnColumnDeleted; // Khi xóa (vì đầy)

            // 2. Lắng nghe từ Firebase (Server)
            _firebase.OnDataChanged += Firebase_OnDataChanged; // Khi dữ liệu đổi
            _firebase.OnItemDeleted += Firebase_OnItemDeleted; // Khi dữ liệu bị xóa
        }

        // ==================================================================================
        // PHẦN PUSH: GỬI LÊN FIREBASE
        // ==================================================================================

        private async void Matrix_OnColumnChanged(CotDuLieuModel colData)
        {
            try
            {
                // Tạo Key dựa trên ID vĩnh viễn: Col_100, Col_101...
                string key = $"Col_{colData.Id}";
                Console.WriteLine($"[MATRIX-SYNC] 📤 Pushing Key: {key} (Status: {colData.Status})");

                // Gửi toàn bộ object lên Firebase
                await _firebase.UpdateDataAsync($"{_nodeName}/{key}", colData);
            }
            catch (Exception ex) { Console.WriteLine($"[ERR] Push Failed: {ex.Message}"); }
        }

        private async void Matrix_OnColumnDeleted(int colId)
        {
            try
            {
                string key = $"Col_{colId}";
                Console.WriteLine($"[MATRIX-SYNC] ✂️ Limit Reached. Deleting Old Key: {key} on Cloud.");

                // Xóa node trên Firebase
                await _firebase.DeleteDataAsync($"{_nodeName}/{key}");
            }
            catch (Exception ex) { Console.WriteLine($"[ERR] Delete Failed: {ex.Message}"); }
        }

        // ==================================================================================
        // PHẦN PULL: NHẬN VỀ TỪ FIREBASE
        // ==================================================================================

        private void Firebase_OnDataChanged(object sender, FirebaseDataEventArgs e)
        {
            if (e.RootNode != _nodeName) return;

            // Firebase trả về Key dạng: "Col_105"
            // Ta parse lấy ID = 105
            if (e.Key.StartsWith("Col_") && int.TryParse(e.Key.Substring(4), out int colId))
            {
                var colData = e.ToObject<CotDuLieuModel>();
                if (colData != null)
                {
                    // Cập nhật vào MatrixManager theo ID
                    _matrix.UpdateColumnById(colId, colData);
                }
            }
        }

        private void Firebase_OnItemDeleted(object sender, FirebaseDeleteEventArgs e)
        {
            if (e.RootNode != _nodeName) return;

            // Nếu nhận được tín hiệu xóa Key "Col_100"
            if (e.TargetId.StartsWith("Col_") && int.TryParse(e.TargetId.Substring(4), out int colId))
            {
                _matrix.DeleteColumnById(colId);
            }
        }

        // ==================================================================================
        // INITIAL LOAD (TẢI LẦN ĐẦU)
        // ==================================================================================

        public async Task LoadInitialData()
        {
            try
            {
                Console.WriteLine($"[MATRIX-SYNC] 📥 Loading all data from Firebase...");
                var dict = await _firebase.GetDataAsync<Dictionary<string, CotDuLieuModel>>(_nodeName);

                if (dict != null)
                {
                    // Chuyển Dictionary -> List
                    var listData = new List<CotDuLieuModel>();
                    foreach (var kvp in dict)
                    {
                        // Parse ID từ Key (để chắc chắn khớp)
                        if (kvp.Key.StartsWith("Col_") && int.TryParse(kvp.Key.Substring(4), out int id))
                        {
                            var item = kvp.Value;
                            item.Id = id; // Gán lại ID cho chắc
                            listData.Add(item);
                        }
                    }

                    // Đẩy vào MatrixManager (Nó sẽ tự sắp xếp theo ID)
                    _matrix.LoadData(listData);
                }
                else
                {
                    Console.WriteLine("[MATRIX-SYNC] Data is empty.");
                }
            }
            catch (Exception ex) { Console.WriteLine($"[ERR] LoadInit: {ex.Message}"); }
        }

        public void Dispose()
        {
            _matrix.OnColumnChanged -= Matrix_OnColumnChanged;
            _matrix.OnColumnDeleted -= Matrix_OnColumnDeleted;
            _firebase.OnDataChanged -= Firebase_OnDataChanged;
            _firebase.OnItemDeleted -= Firebase_OnItemDeleted;
        }
    }
}



==========================================
FILE: SyncCoordinator.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\SyncCoordinator.cs
==========================================
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows.Forms;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using UBCS2_A.Helpers;

namespace UBCS2_A.Services
{
    /// <summary>
    /// Lớp trung gian điều phối việc đồng bộ dữ liệu.
    /// Nhiệm vụ:
    /// 1. Nghe sự kiện từ Grid -> Đẩy lên Firebase.
    /// 2. Nghe sự kiện từ Firebase -> Cập nhật lại Grid.
    /// 3. Mapping giữa dòng (Row Index) và khóa (Firebase Key).
    /// </summary>
    public class SyncCoordinator<T> : IDisposable where T : class, new()
    {
        private readonly GridManager<T> _grid;
        private readonly FirebaseService _firebase;
        private readonly string _firebaseNodeName; // Tên bảng (VD: Table1)
        private readonly Func<int, T, string> _mapRowToKey; // Hàm đổi Row -> Key
        private readonly Func<string, int> _mapKeyToRow;    // Hàm đổi Key -> Row
                                                            // Thêm 1 biến Func để kiểm tra điều kiện xóa
        private readonly Func<T, bool> _checkIfEmpty;

        // Cập nhật Constructor để nhận hàm kiểm tra này
        public SyncCoordinator(GridManager<T> grid, FirebaseService firebase, string nodeName,
                               Func<int, T, string> mapRowToKey,
                               Func<string, int> mapKeyToRow,
                               Func<T, bool> checkIfEmpty = null) // <--- THÊM THAM SỐ NÀY
        {
            _grid = grid;
            _firebase = firebase;
            _firebaseNodeName = nodeName;
            _mapRowToKey = mapRowToKey;
            _mapKeyToRow = mapKeyToRow;
            _checkIfEmpty = checkIfEmpty; // Lưu lại
        }

        /// <summary>
        /// Kích hoạt việc lắng nghe 2 chiều (Grid <-> Firebase).
        /// </summary>
        public void StartSync()
        {
            Console.WriteLine($"[SYNC] Started for Node: {_firebaseNodeName}");
            _grid.OnUserChangedData += Grid_OnUserChangedData;
            _firebase.OnDataChanged += Firebase_OnDataChanged;
            _firebase.OnItemDeleted += Firebase_OnItemDeleted;
        }

        /// <summary>
        /// Xử lý khi Người dùng sửa dữ liệu trên Grid.
        /// Đẩy dữ liệu đó lên Firebase (Hàm Async).
        /// </summary>
        // Sửa hàm xử lý khi Grid thay đổi
        private async void Grid_OnUserChangedData(int rowIndex, T data)
        {
            try
            {
                string key = _mapRowToKey(rowIndex, data);
                if (string.IsNullOrEmpty(key)) return;

                // KIỂM TRA: Nếu có hàm check rỗng VÀ dữ liệu thỏa mãn là rỗng
                if (_checkIfEmpty != null && _checkIfEmpty(data))
                {
                    Console.WriteLine($"[SYNC] Data empty -> DELETING Key: {key}");
                    // Xóa hẳn node trên Firebase
                    await _firebase.DeleteDataAsync($"{_firebaseNodeName}/{key}");
                }
                else
                {
                    Console.WriteLine($"[SYNC] Data valid -> UPDATING Key: {key}");
                    // Cập nhật như cũ
                    await _firebase.UpdateDataAsync($"{_firebaseNodeName}/{key}", data);
                }
            }
            catch (Exception ex) { Console.WriteLine($"[SYNC-ERR] {ex.Message}"); }
        }

        /// <summary>
        /// Xử lý khi Firebase báo có dữ liệu thay đổi (Realtime).
        /// Tìm dòng tương ứng trên Grid và cập nhật.
        /// </summary>
        private void Firebase_OnDataChanged(object sender, FirebaseDataEventArgs e)
        {
            if (e.RootNode != _firebaseNodeName) return; // Không phải bảng này thì bỏ qua

            int rowIndex = _mapKeyToRow(e.Key);
            Console.WriteLine($"[SYNC] Firebase Changed (Key {e.Key}) -> Mapping to Row {rowIndex}");

            if (rowIndex >= 0) _grid.UpdateSingleRow(rowIndex, e.Data);
            else Console.WriteLine($"[SYNC-WARN] Ignored Key {e.Key} (Out of range or invalid)");
        }

        /// <summary>
        /// Xử lý khi Firebase báo có dữ liệu bị xóa.
        /// </summary>
        private void Firebase_OnItemDeleted(object sender, FirebaseDeleteEventArgs e)
        {
            if (e.RootNode != _firebaseNodeName) return;
            Console.WriteLine($"[SYNC] Firebase Deleted ID: {e.TargetId}");

            if (e.TargetId == "ALL") _grid.ClearAll(); // Xóa sạch bảng
            else
            {
                // Xóa 1 dòng (Thực tế là reset dòng đó về rỗng)
                int rowIndex = _mapKeyToRow(e.TargetId);
                if (rowIndex >= 0) _grid.UpdateSingleRow(rowIndex, JToken.FromObject(new T()));
            }
        }

        /// <summary>
        /// Tải dữ liệu ban đầu khi mới mở App.
        /// Xử lý cả 2 trường hợp Firebase trả về: Array [] hoặc Dictionary {}.
        /// </summary>
        public async Task LoadInitialData()
        {
            try
            {
                Console.WriteLine($"[SYNC] Loading Initial Data for {_firebaseNodeName}...");
                string json = await _firebase.GetDataAsync<string>(_firebaseNodeName);

                if (string.IsNullOrEmpty(json) || json == "null")
                {
                    Console.WriteLine("[SYNC] Data is empty/null on server.");
                    return;
                }

                var dataForGrid = new Dictionary<int, T>();
                int count = 0;

                // Firebase có thể trả về Mảng [...] hoặc Object {...} tùy vào Key là số liên tục hay chuỗi
                if (json.Trim().StartsWith("["))
                {
                    // Logic xử lý dạng Mảng
                    Console.WriteLine("[SYNC] Detected Array format");
                    var listData = JsonConvert.DeserializeObject<List<T>>(json);
                    if (listData != null)
                    {
                        for (int i = 0; i < listData.Count; i++)
                        {
                            if (listData[i] != null)
                            {
                                int rowIndex = _mapKeyToRow(i.ToString());
                                if (rowIndex == -1) rowIndex = i; // Fallback
                                if (rowIndex >= 0) dataForGrid[rowIndex] = listData[i];
                                count++;
                            }
                        }
                    }
                }
                else
                {
                    // Logic xử lý dạng Object/Dictionary
                    Console.WriteLine("[SYNC] Detected Dictionary/Object format");
                    var dictData = JsonConvert.DeserializeObject<Dictionary<string, T>>(json);
                    if (dictData != null)
                    {
                        foreach (var kvp in dictData)
                        {
                            int rowIndex = _mapKeyToRow(kvp.Key);
                            if (rowIndex >= 0) dataForGrid[rowIndex] = kvp.Value;
                            count++;
                        }
                    }
                }

                Console.WriteLine($"[SYNC] Loaded {count} records into Grid.");
                if (dataForGrid.Count > 0) _grid.LoadFullData(dataForGrid);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[SYNC-ERR] LoadInitialData: {ex.Message}");
            }
        }

        public void Dispose()
        {
            Console.WriteLine($"[SYNC] Disposing coordinator for {_firebaseNodeName}");
            _grid.OnUserChangedData -= Grid_OnUserChangedData;
            _firebase.OnDataChanged -= Firebase_OnDataChanged;
            _firebase.OnItemDeleted -= Firebase_OnItemDeleted;
        }
    }
}



==========================================
FILE: TaskContext.cs
PATH: D:\VS Projects\Backup\UBCS2-A\Services\TaskContext.cs
==========================================
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;
using UBCS2_A.Helpers;
using UBCS2_A.Models;
using Newtonsoft.Json.Linq;

namespace UBCS2_A.Services
{
    public class TaskContext : IDisposable
    {
        private readonly FirebaseService _firebaseService;
        private GridManager<TaskModel> _gridManager;
        private DataGridView _dgv;

        private List<TaskModel> _taskList = new List<TaskModel>();
        private List<TaskModel> _displayList = new List<TaskModel>();

        private readonly object _lock = new object();
        private int _currentMaxId = 0;
        private string _nodeName = "T_Tasks";
        private const int MAX_KEEP_TASKS = 200;
        private string _currentRole = "Khách";
        private bool _isInitialLoadComplete = false;
        private readonly HashSet<string> _restrictedAreas = new HashSet<string>()
        {
            "Huyết học T1", "Sinh hóa T1", "Miễn dịch T1",
            "Huyết học T3", "SH-MD T3", "Hành Chánh T1", "Hành Chánh T3"
        };

        public TaskContext(FirebaseService firebaseService)
        {
            _firebaseService = firebaseService;
        }

        public void RegisterTaskTable(DataGridView dgv, string nodeName, int maxRows = 200)
        {
            _nodeName = nodeName;
            _dgv = dgv;
            dgv.AutoGenerateColumns = false;
            dgv.Columns.Clear();
            dgv.BackgroundColor = Color.White;
            dgv.RowHeadersVisible = false;
            dgv.AllowUserToResizeRows = false;
            dgv.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dgv.CellBorderStyle = DataGridViewCellBorderStyle.SingleHorizontal;
            dgv.ColumnHeadersVisible = false;
            dgv.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.DisplayedCells;

            var colTask = new DataGridViewTextBoxColumn();
            colTask.HeaderText = "Nhiệm Vụ";
            colTask.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill;
            colTask.DefaultCellStyle.WrapMode = DataGridViewTriState.True;
            colTask.DefaultCellStyle.Padding = new Padding(10, 8, 10, 8);
            colTask.DefaultCellStyle.Font = new Font("Segoe UI", 10, FontStyle.Regular);
            dgv.Columns.Add(colTask);

            _gridManager = new GridManager<TaskModel>(dgv, maxRows);

            _gridManager.OnGetValue = (rowIndex, model, colIndex) =>
            {
                // Nếu là dòng rỗng -> Trả về chuỗi rỗng
                if (model == null || (model.Id == 0 && string.IsNullOrEmpty(model.SID)))
                    return "";

                string statusIcon = "⭕";
                if (model.TrangThai == 2) statusIcon = "⚡";
                else if (model.TrangThai == 1) statusIcon = "✅";

                string line1 = $"{statusIcon}  [{model.KhuVucNhan}]  SID: {model.SID}";
                string line2 = $"      ➥ {model.NoiDung}";
                return line1 + "\r\n" + line2;
            };

            dgv.KeyDown += Dgv_KeyDown;
            dgv.CellFormatting += Dgv_CellFormatting;
            dgv.CellDoubleClick += Dgv_CellDoubleClick;
        }

        // =========================================================================
        // [PHẦN XỬ LÝ SỰ KIỆN]
        // =========================================================================

        public void StartSync()
        {
            _firebaseService.OnDataChanged += Firebase_OnDataChanged;
            _firebaseService.OnItemDeleted += Firebase_OnItemDeleted;
        }

        private void Firebase_OnDataChanged(object sender, FirebaseDataEventArgs e)
        {
            // [CÁCH 1] BẮT LỆNH HỆ THỐNG (SYSTEM COMMAND)
            // Nếu nhận được lệnh "BACKUP_WIPE" -> Tự động xóa trắng Task luôn
            if (e.Path.Contains("System") || e.Key == "Command")
            {
                string dataStr = e.Data?.ToString() ?? "";
                if (dataStr.Contains("BACKUP_WIPE"))
                {
                    Console.WriteLine("[TASK-SYNC] 🧹 Nhận lệnh hệ thống: XÓA SẠCH!");
                    ClearAllLocalData();
                    return;
                }
            }

            // [CÁCH 2] BẮT SỰ KIỆN XÓA BẢNG TRUYỀN THỐNG
            bool isDeleteAll = (e.Path.Contains(_nodeName) && (e.Data == null || e.Data.Type == JTokenType.Null));
            if (isDeleteAll)
            {
                Console.WriteLine($"[TASK-SYNC] 🧹 Server đã xóa bảng {_nodeName}!");
                ClearAllLocalData();
                return;
            }

            // Xử lý dữ liệu con (Task_X)
            if (!e.Path.Contains(_nodeName) && e.RootNode != _nodeName) return;

            string checkString = (!string.IsNullOrEmpty(e.Key) ? e.Key : e.Path);
            if (checkString.Contains("Task_"))
            {
                string idPart = checkString.Substring(checkString.LastIndexOf("Task_") + 5);
                if (int.TryParse(idPart, out int id))
                {
                    var newTask = e.ToObject<TaskModel>();
                    if (newTask == null) // Data null -> Xóa dòng
                    {
                        HandleSingleItemDelete(id);
                        return;
                    }
                    newTask.Id = id;
                    if (_dgv.InvokeRequired) _dgv.BeginInvoke(new Action(() => ProcessSync(newTask, id)));
                    else ProcessSync(newTask, id);
                }
            }
        }

        private void Firebase_OnItemDeleted(object sender, FirebaseDeleteEventArgs e)
        {
            // Bắt sự kiện DELETE node cha
            if (e.TargetId == _nodeName || (e.RootNode == _nodeName && string.IsNullOrEmpty(e.TargetId)))
            {
                Console.WriteLine($"[TASK-SYNC] 🧹 Server đã DELETE bảng {_nodeName}!");
                ClearAllLocalData();
                return;
            }

            if (e.RootNode != _nodeName) return;

            if (e.TargetId.StartsWith("Task_") && int.TryParse(e.TargetId.Substring(5), out int id))
            {
                HandleSingleItemDelete(id);
            }
        }

        // [QUAN TRỌNG] Hàm xóa sạch dữ liệu và ép Grid trắng
        private void ClearAllLocalData()
        {
            lock (_lock)
            {
                _taskList.Clear();
                _currentMaxId = 0;

                // 1. Xóa trong GridManager (quan trọng để reset các dòng ảo)
                _gridManager?.ClearAll();

                // 2. Refresh lại logic hiển thị
                RefreshGrid();
            }

            // 3. Ép UI vẽ lại ngay lập tức
            if (_dgv.IsHandleCreated) _dgv.BeginInvoke((Action)(() => _dgv.Invalidate()));
        }

        // ... (Các hàm logic cũ bên dưới GIỮ NGUYÊN) ...

        public async Task LoadInitialDataAsync()
        {
            try
            {
                var dict = await _firebaseService.GetDataAsync<Dictionary<string, TaskModel>>(_nodeName);
                lock (_lock)
                {
                    _taskList.Clear();
                    _currentMaxId = 0;
                    if (dict != null)
                    {
                        foreach (var kvp in dict)
                        {
                            if (kvp.Key.StartsWith("Task_") && int.TryParse(kvp.Key.Substring(5), out int id))
                            {
                                var t = kvp.Value; t.Id = id;
                                _taskList.Add(t);
                                if (id > _currentMaxId) _currentMaxId = id;
                            }
                        }
                    }
                    _taskList = _taskList.OrderBy(t => t.Id).ToList();
                    RefreshGrid();
                    _isInitialLoadComplete = true;
                }
            }
            catch (Exception ex) { Console.WriteLine($"[TASK-ERR] {ex.Message}"); }
        }

        private void HandleSingleItemDelete(int id)
        {
            lock (_lock)
            {
                var target = _taskList.FirstOrDefault(t => t.Id == id);
                if (target != null)
                {
                    _taskList.Remove(target);
                    RefreshGrid();
                }
            }
        }

        private void ProcessSync(TaskModel newTask, int id)
        {
            lock (_lock)
            {
                if (id > _currentMaxId) _currentMaxId = id;
                var existing = _taskList.FirstOrDefault(t => t.Id == id);
                bool isNew = (existing == null);

                if (isNew)
                {
                    _taskList.Add(newTask);
                    _taskList = _taskList.OrderBy(t => t.Id).ToList();

                    if (_isInitialLoadComplete && newTask.TrangThai == 0 &&
                        string.Equals(newTask.KhuVucNhan, _currentRole, StringComparison.OrdinalIgnoreCase))
                    {
                        ShowFlashPopup(newTask);
                    }
                }
                else
                {
                    int idx = _taskList.IndexOf(existing);
                    _taskList[idx] = newTask;
                }

                while (_taskList.Count > MAX_KEEP_TASKS) _taskList.RemoveAt(0);
                RefreshGrid();
            }
        }

        private void ShowFlashPopup(TaskModel task)
        {
            var popup = new FlashTaskForm(task);
            popup.OnConfirm += (t) => {
                t.TrangThai = 2; // Received
                _firebaseService.UpdateDataAsync($"{_nodeName}/Task_{t.Id}", t);
                RefreshGrid();
            };
            popup.Show();
        }

        // [Các hàm giao diện cũ giữ nguyên]
        private void Dgv_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete && _dgv.SelectedRows.Count > 0)
            {
                var tasksToDelete = new List<TaskModel>();
                foreach (DataGridViewRow row in _dgv.SelectedRows)
                {
                    if (row.Index >= 0 && row.Index < _displayList.Count)
                        tasksToDelete.Add(_displayList[row.Index]);
                }
                DeleteTasks(tasksToDelete);
                e.Handled = true;
            }
        }

        private void DeleteTasks(List<TaskModel> tasks)
        {
            lock (_lock)
            {
                foreach (var task in tasks)
                {
                    _firebaseService.DeleteDataAsync($"{_nodeName}/Task_{task.Id}");
                    var itemInMaster = _taskList.FirstOrDefault(t => t.Id == task.Id);
                    if (itemInMaster != null) _taskList.Remove(itemInMaster);
                }
                RefreshGrid();
            }
        }

        public void AddNewTask(TaskModel newTask)
        {
            lock (_lock)
            {
                _currentMaxId++;
                newTask.Id = _currentMaxId;
                newTask.TrangThai = 0;
                _taskList.Add(newTask);
                _firebaseService.UpdateDataAsync($"{_nodeName}/Task_{newTask.Id}", newTask);
                if (_taskList.Count > MAX_KEEP_TASKS)
                {
                    var oldTask = _taskList[0];
                    _taskList.RemoveAt(0);
                    _firebaseService.DeleteDataAsync($"{_nodeName}/Task_{oldTask.Id}");
                }
                RefreshGrid();
            }
        }

        public void SetCurrentUserRole(string role)
        {
            _currentRole = role;
            RefreshGrid();
        }

        private void RefreshGrid()
        {
            lock (_lock)
            {
                bool isRestricted = _restrictedAreas.Contains(_currentRole);
                _displayList.Clear();
                foreach (var task in _taskList)
                {
                    if (isRestricted)
                    {
                        if (string.Equals(task.KhuVucNhan, _currentRole, StringComparison.OrdinalIgnoreCase))
                            _displayList.Add(task);
                    }
                    else _displayList.Add(task);
                }
                var dict = new Dictionary<int, TaskModel>();
                for (int i = 0; i < _displayList.Count; i++) dict[i] = _displayList[i];
                _gridManager.LoadFullData(dict);
            }
        }

        private void Dgv_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < _displayList.Count)
            {
                var task = _displayList[e.RowIndex];
                if (task.TrangThai == 1) // Done
                {
                    e.CellStyle.BackColor = Color.FromArgb(220, 255, 220);
                    e.CellStyle.ForeColor = Color.DarkGreen;
                }
                else if (task.TrangThai == 2) // Received
                {
                    e.CellStyle.BackColor = Color.FromArgb(255, 250, 205);
                    e.CellStyle.ForeColor = Color.FromArgb(139, 69, 19);
                }
                else // New
                {
                    e.CellStyle.BackColor = Color.White;
                    e.CellStyle.ForeColor = Color.Black;
                }
            }
        }

        private void Dgv_CellDoubleClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < _displayList.Count)
            {
                var task = _displayList[e.RowIndex];
                int nextStatus = (task.TrangThai == 0) ? 2 : (task.TrangThai == 2 ? 1 : 0);
                string msg = (nextStatus == 2) ? "Đã Nhận" : (nextStatus == 1 ? "Hoàn Thành" : "Làm Lại");

                if (MessageBox.Show($"Chuyển trạng thái sang: {msg}?", "Cập nhật", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                {
                    task.TrangThai = nextStatus;
                    _firebaseService.UpdateDataAsync($"{_nodeName}/Task_{task.Id}", task);
                    RefreshGrid();
                }
            }
        }

        public void Dispose()
        {
            _firebaseService.OnDataChanged -= Firebase_OnDataChanged;
            _firebaseService.OnItemDeleted -= Firebase_OnItemDeleted;
        }
    }
}



